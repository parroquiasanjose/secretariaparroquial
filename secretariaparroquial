<!DOCTYPE html>
<html lang="es" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Módulo de Secretaría - Parroquia San José</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: Inter & Noto Serif for certificates -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Serif:wght@400;700&display=swap" rel="stylesheet">
    
    <!-- Feather Icons -->
    <script src="https://unpkg.com/feather-icons"></script>

    <!-- PDF Generation Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; }
        .card-hover-effect { transition: transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out; }
        .card-hover-effect:hover { transform: translateY(-10px); box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1); }
        .hidden { display: none; }

        /* A4 Page container for PDF */
        .pdf-page-container {
            width: 210mm;
            height: 297mm;
            padding: 10mm;
            box-sizing: border-box;
            background-color: #fff;
            display: flex;
            flex-direction: column;
            font-family: 'Noto Serif', serif;
            color: #333;
        }

        /* Certificate Styles */
        .certificate-modern {
            border: 1px solid #e0e0e0;
            padding: 10mm;
            background-color: #f7f7f7;
        }
        .certificate-modern-header {
            text-align: center;
            border-bottom: 2px solid #a3804b;
            padding-bottom: 10px;
            margin-bottom: 10mm;
        }
        .certificate-modern-header h3 {
            font-size: 22pt;
            font-weight: 700;
            color: #a3804b;
            margin: 0;
            letter-spacing: 2px;
        }
        .certificate-modern-header p {
            font-family: 'Inter', sans-serif;
            font-size: 9pt;
            color: #555;
            margin: 2px 0;
            line-height: 1.5;
        }
        .certificate-modern-body {
            font-size: 11pt;
            line-height: 2.2;
            text-align: justify;
        }
        .certificate-modern-body strong {
            font-weight: 700;
            color: #000;
        }
        .certificate-modern-body .field {
            font-family: 'Inter', sans-serif;
            font-weight: 500;
            border-bottom: 1px dotted #888;
            padding: 0 8px;
        }
        .certificate-modern-footer {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            margin-top: 15mm;
            border-top: 1px solid #e0e0e0;
            padding-top: 10mm;
            font-family: 'Inter', sans-serif;
            font-size: 10pt;
        }
        .signature-line {
            border-top: 1px solid #555;
            width: 60mm;
            text-align: center;
            padding-top: 5px;
        }

        /* Notification & Ficha Box Styles */
        .notification-container {
            display: flex;
            gap: 10mm;
            margin-top: 10mm;
            flex-grow: 1;
        }
        .notification-box {
            border: 1px solid #ccc;
            padding: 5mm;
            flex: 1;
            font-size: 9pt;
            line-height: 1.8;
            display: flex;
            flex-direction: column;
        }
        .notification-box h4 {
            text-align: center;
            font-weight: bold;
            font-size: 10pt;
            margin-bottom: 5mm;
        }
        .notification-box .field-line {
            border-bottom: 1px dotted #888;
            flex-grow: 1;
            margin-left: 4px;
        }
        .notification-box p {
            display: flex;
        }
        .notification-box .footer-note {
            font-size: 7pt;
            text-align: center;
            margin-top: auto;
            padding-top: 5mm;
            font-style: italic;
        }
        
        /* Loading Spinner */
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .spinner {
            border-color: #fff;
            border-top-color: transparent;
            animation: spin 1s linear infinite;
        }

        /* Toast Notifications */
        @keyframes toast-in {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes toast-out {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }
        .toast {
            animation: toast-in 0.5s, toast-out 0.5s 3s;
        }

        /* Print-specific styles */
        @media print {
            body, body * { visibility: hidden; }
            .printable-area, .printable-area * { visibility: visible; }
            .printable-area { position: absolute; left: 0; top: 0; width: 100%; }
            .no-print { display: none !important; }
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-slate-900 text-gray-800 dark:text-gray-200">

    <!-- LOGIN VIEW -->
    <section id="login-view" class="min-h-screen flex items-center justify-center">
        <div class="bg-white dark:bg-gray-800 p-8 rounded-2xl shadow-lg w-full max-w-md">
            <h2 class="text-3xl font-bold text-center mb-2">Secretaría Parroquial</h2>
            <p class="text-center text-gray-600 dark:text-gray-400 mb-8">Acceso</p>
            <form id="login-form" class="space-y-6">
                <div>
                    <label for="email" class="block text-sm font-medium">Correo</label>
                    <input type="email" id="email" class="mt-1 block w-full rounded-md p-2 border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700" required>
                </div>
                <div>
                    <label for="password" class="block text-sm font-medium">Contraseña</label>
                    <div class="relative">
                        <input type="password" id="password" class="mt-1 block w-full rounded-md p-2 border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700" required>
                        <button type="button" id="toggle-password" class="absolute inset-y-0 right-0 px-3 flex items-center text-gray-500">
                            <i data-feather="eye" class="icon-eye"></i>
                            <i data-feather="eye-off" class="icon-eye-off hidden"></i>
                        </button>
                    </div>
                </div>
                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg">Ingresar</button>
            </form>
        </div>
    </section>

    <!-- Main App Container (hidden by default) -->
    <main id="app-container" class="hidden">
        <!-- DASHBOARD DE SECRETARÍA -->
        <section id="secretaria-dashboard" data-view="secretaria-dashboard" class="min-h-screen">
            <div class="container mx-auto px-6 py-20">
                <div class="flex justify-between items-center mb-12">
                    <h2 class="text-3xl font-bold">Secretaría Parroquia San José</h2>
                    <div class="flex items-center space-x-4">
                        <div id="notification-bell-container" class="relative cursor-pointer" data-action="show-view" data-view-id="notifications-content">
                            <i data-feather="bell" class="h-8 w-8 text-gray-600 dark:text-gray-300"></i>
                            <span id="notification-badge" class="hidden absolute -top-2 -right-2 bg-red-500 text-white text-xs font-bold rounded-full h-5 w-5 flex items-center justify-center"></span>
                        </div>
                        <button id="logout-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg">Cerrar Sesión</button>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                    <div data-action="show-view" data-view-id="certificate-choice-content" class="card-hover-effect bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-8 flex flex-col items-center text-center cursor-pointer">
                        <div class="bg-indigo-100 dark:bg-indigo-900/30 p-4 rounded-full mb-6"><i data-feather="file-text" class="h-10 w-10 text-indigo-600 dark:text-indigo-400"></i></div>
                        <h3 class="text-2xl font-bold mb-2">Certificados</h3>
                        <p class="text-gray-600 dark:text-gray-400">Generar certificados de Bautismo y Confirmación.</p>
                    </div>
                    <div data-action="show-view" data-view-id="mass-org-content" class="card-hover-effect bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-8 flex flex-col items-center text-center cursor-pointer">
                        <div class="bg-teal-100 dark:bg-teal-900/30 p-4 rounded-full mb-6"><i data-feather="calendar" class="h-10 w-10 text-teal-600 dark:text-teal-400"></i></div>
                        <h3 class="text-2xl font-bold mb-2">Organización de Misas</h3>
                        <p class="text-gray-600 dark:text-gray-400">Gestionar horarios de misas y ministros.</p>
                    </div>
                    <div data-action="show-view" data-view-id="notifications-content" class="card-hover-effect bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-8 flex flex-col items-center text-center cursor-pointer">
                        <div class="bg-amber-100 dark:bg-amber-900/30 p-4 rounded-full mb-6"><i data-feather="bell" class="h-10 w-10 text-amber-600 dark:text-amber-400"></i></div>
                        <h3 class="text-2xl font-bold mb-2">Notificaciones</h3>
                        <p class="text-gray-600 dark:text-gray-400">Crear y ver recordatorios y anuncios internos.</p>
                    </div>
                    <div data-action="show-view" data-view-id="email-content" class="card-hover-effect bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-8 flex flex-col items-center text-center cursor-pointer">
                        <div class="bg-rose-100 dark:bg-rose-900/30 p-4 rounded-full mb-6"><i data-feather="mail" class="h-10 w-10 text-rose-600 dark:text-rose-400"></i></div>
                        <h3 class="text-2xl font-bold mb-2">Correo Electrónico</h3>
                        <p class="text-gray-600 dark:text-gray-400">Interfaz para visualizar correos de la parroquia.</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- PANTALLA DE ELECCIÓN DE CERTIFICADO -->
        <section id="certificate-choice-content" data-view="certificate-choice-content" class="hidden min-h-screen">
            <div class="container mx-auto px-6 py-12">
                <div class="flex justify-between items-center mb-12">
                    <h2 class="text-3xl font-bold">Seleccionar Tipo de Certificado</h2>
                    <button data-action="show-view" data-view-id="secretaria-dashboard" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg">Inicio</button>
                </div>
                <div class="flex justify-center">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-10 w-full max-w-4xl">
                        <div data-action="show-view" data-view-id="bautismo-content" class="card-hover-effect bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-8 flex flex-col items-center text-center cursor-pointer">
                            <div class="bg-sky-100 dark:bg-sky-900/30 p-4 rounded-full mb-6"><i data-feather="droplet" class="h-10 w-10 text-sky-600 dark:text-sky-400"></i></div>
                            <h2 class="text-2xl font-bold mb-2">Certificado de Bautismo</h2>
                            <p class="text-gray-600 dark:text-gray-400">Crear un nuevo certificado de bautismo.</p>
                        </div>
                        <div data-action="show-view" data-view-id="confirmacion-content" class="card-hover-effect bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-8 flex flex-col items-center text-center cursor-pointer">
                            <div class="bg-red-100 dark:bg-red-900/30 p-4 rounded-full mb-6"><i data-feather="wind" class="h-10 w-10 text-red-600 dark:text-red-400"></i></div>
                            <h2 class="text-2xl font-bold mb-2">Certificado de Confirmación</h2>
                            <p class="text-gray-600 dark:text-gray-400">Crear un nuevo certificado de confirmación.</p>
                        </div>
                    </div>
                </div>

                <!-- REGISTROS -->
                <div class="mt-16 grid grid-cols-1 lg:grid-cols-2 gap-12">
                    <!-- Registros de Bautismo -->
                    <div>
                        <h3 class="text-2xl font-bold mb-4">Últimos Registros de Bautismo</h3>
                        <div class="mb-4 relative">
                            <input type="search" id="bautismo-search" placeholder="Buscar por nombre, fecha, padrinos..." class="w-full rounded-md p-2 pl-10 border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 focus:ring-indigo-500 focus:border-indigo-500">
                            <i data-feather="search" class="absolute left-3 top-1/2 -translate-y-1/2 h-5 w-5 text-gray-400"></i>
                        </div>
                        <div id="bautismo-records-container" class="space-y-3"></div>
                        <div id="bautismo-pagination-container" class="mt-4 flex justify-between items-center"></div>
                    </div>
                    <!-- Registros de Confirmación -->
                    <div>
                        <h3 class="text-2xl font-bold mb-4">Últimos Registros de Confirmación</h3>
                        <div class="mb-4 relative">
                            <input type="search" id="confirmacion-search" placeholder="Buscar por nombre, fecha..." class="w-full rounded-md p-2 pl-10 border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 focus:ring-indigo-500 focus:border-indigo-500">
                             <i data-feather="search" class="absolute left-3 top-1/2 -translate-y-1/2 h-5 w-5 text-gray-400"></i>
                        </div>
                        <div id="confirmacion-records-container" class="space-y-3"></div>
                        <div id="confirmacion-pagination-container" class="mt-4 flex justify-between items-center"></div>
                    </div>
                </div>
            </div>
        </section>

        <!-- MÓDULO DE CERTIFICADOS DE BAUTISMO -->
        <section id="bautismo-content" data-view="bautismo-content" class="hidden min-h-screen">
            <div class="container mx-auto px-6 py-12">
                <div class="flex justify-between items-center mb-8">
                    <h2 class="text-3xl font-bold">Gestión de Certificados de Bautismo</h2>
                    <button data-action="show-view" data-view-id="certificate-choice-content" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg">Volver a Elegir</button>
                </div>
                <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-8">
                    <form id="baptism-form" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <input type="hidden" name="id" id="b-id">
                        <h3 class="col-span-full text-xl font-bold text-gray-900 dark:text-white border-b pb-2">Datos del Certificado</h3>
                        <div><label for="b-libro" class="block text-sm font-medium">Libro N°</label><input name="libro" type="text" id="b-libro" class="mt-1 block w-full rounded-md p-2 border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700" required></div>
                        <div><label for="b-folio" class="block text-sm font-medium">Folio N°</label><input name="folio" type="text" id="b-folio" class="mt-1 block w-full rounded-md p-2 border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700" required></div>
                        <div class="md:col-span-2"><label for="b-nombre" class="block text-sm font-medium">Nombre y Apellido del Bautizado</label><input name="nombre" type="text" id="b-nombre" class="mt-1 block w-full rounded-md p-2 border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700" required></div>
                        <div><label for="b-dni" class="block text-sm font-medium">DNI</label><input name="dni" type="text" id="b-dni" class="mt-1 block w-full rounded-md p-2 border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700"></div>
                        <div><label for="b-fecha-nac" class="block text-sm font-medium">Fecha de Nacimiento</label><input name="fechaNac" type="date" id="b-fecha-nac" class="mt-1 block w-full rounded-md p-2 border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700" required></div>
                        <div class="md:col-span-2"><label for="b-lugar-nac" class="block text-sm font-medium">Nacido en</label><input name="lugarNac" type="text" id="b-lugar-nac" class="mt-1 block w-full rounded-md p-2 border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700" required></div>
                        <div><label for="b-padre" class="block text-sm font-medium">Hijo de (Padre)</label><input name="padre" type="text" id="b-padre" class="mt-1 block w-full rounded-md p-2 border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700"></div>
                        <div><label for="b-madre" class="block text-sm font-medium">y de (Madre)</label><input name="madre" type="text" id="b-madre" class="mt-1 block w-full rounded-md p-2 border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700" required></div>
                        <div><label for="b-fecha-bautismo" class="block text-sm font-medium">Fecha del Bautismo</label><input name="fechaBautismo" type="date" id="b-fecha-bautismo" class="mt-1 block w-full rounded-md p-2 border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700" required></div>
                        <div><label for="b-padrino" class="block text-sm font-medium">Padrino</label><input name="padrino" type="text" id="b-padrino" class="mt-1 block w-full rounded-md p-2 border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700" required></div>
                        <div><label for="b-madrina" class="block text-sm font-medium">Madrina</label><input name="madrina" type="text" id="b-madrina" class="mt-1 block w-full rounded-md p-2 border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700" required></div>
                        <div class="md:col-span-2"><label for="b-notas" class="block text-sm font-medium">Notas Marginales</label><textarea name="notas" id="b-notas" rows="3" class="mt-1 block w-full rounded-md p-2 border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700"></textarea></div>
                        <div class="md:col-span-2 flex justify-end space-x-4">
                            <button type="button" data-action="generate-certificate" data-type="bautismo" data-format="pdf" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg flex items-center space-x-2">
                                <i data-feather="download" class="h-4 w-4"></i>
                                <span>Descargar PDF</span>
                            </button>
                            <button type="submit" data-action="generate-certificate" data-type="bautismo" data-format="print" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg flex items-center space-x-2">
                                <i data-feather="printer" class="h-4 w-4"></i>
                                <span>Generar e Imprimir</span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </section>

        <!-- MÓDULO DE CERTIFICADOS DE CONFIRMACIÓN (RESTRUCTURED) -->
        <section id="confirmacion-content" data-view="confirmacion-content" class="hidden min-h-screen">
            <div class="container mx-auto px-6 py-12">
                <div class="flex justify-between items-center mb-8">
                    <h2 class="text-3xl font-bold">Gestión de Certificados de Confirmación</h2>
                    <button data-action="show-view" data-view-id="certificate-choice-content" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg">Volver a Elegir</button>
                </div>
                <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-8">
                    <form id="confirmation-form" class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
                        <input type="hidden" name="id" id="c-id">
                        <h3 class="col-span-full text-xl font-bold text-gray-900 dark:text-white border-b pb-2">Datos del Certificado</h3>
                        
                        <div class="md:col-span-2"><label for="c-nombre" class="block text-sm font-medium">Certifico que (Nombre completo)</label><input name="nombre" type="text" id="c-nombre" class="mt-1 block w-full rounded-md p-2 border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700" required></div>
                        <div><label for="c-padre" class="block text-sm font-medium">Hijo(a) de</label><input name="padre" type="text" id="c-padre" class="mt-1 block w-full rounded-md p-2 border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700" required></div>
                        <div><label for="c-madre" class="block text-sm font-medium">y de</label><input name="madre" type="text" id="c-madre" class="mt-1 block w-full rounded-md p-2 border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700" required></div>
                        <div><label for="c-padrino" class="block text-sm font-medium">Padrino/Madrina</label><input name="padrino" type="text" id="c-padrino" class="mt-1 block w-full rounded-md p-2 border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700" required></div>
                        <div><label for="c-fecha-confirmacion" class="block text-sm font-medium">Fecha de Confirmación</label><input name="fechaConfirmacion" type="date" id="c-fecha-confirmacion" class="mt-1 block w-full rounded-md p-2 border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700" required></div>
                        <div><label for="c-pagina" class="block text-sm font-medium">Página N°</label><input name="pagina" type="text" id="c-pagina" class="mt-1 block w-full rounded-md p-2 border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700" required></div>
                        <div><label for="c-acta" class="block text-sm font-medium">Acta N°</label><input name="acta" type="text" id="c-acta" class="mt-1 block w-full rounded-md p-2 border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700" required></div>
                        <div>
                            <label for="c-lugar-select" class="block text-sm font-medium">Lugar de expedición</label>
                            <select id="c-lugar-select" class="mt-1 block w-full rounded-md p-2 border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700">
                                <option>Paso de los Libres, Corrientes</option>
                                <option value="otro">Otro...</option>
                            </select>
                            <input type="hidden" name="lugarExpedicion" id="c-lugar-expedicion-hidden" value="Paso de los Libres, Corrientes">
                        </div>
                        <div><label for="c-fecha-expedicion" class="block text-sm font-medium">Fecha de expedición</label><input name="fechaExpedicion" type="date" id="c-fecha-expedicion" class="mt-1 block w-full rounded-md p-2 border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700" required></div>
                        <div class="md:col-span-2"><label for="c-parroco" class="block text-sm font-medium">Párroco/Ministro</label><input name="parroco" type="text" id="c-parroco" class="mt-1 block w-full rounded-md p-2 border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700" required></div>

                        <h3 class="col-span-full text-xl font-bold text-gray-900 dark:text-white border-b pb-2 mt-4">Datos del Bautismo (para notificación)</h3>
                        <div class="md:col-span-2"><label for="c-bautizado-en" class="block text-sm font-medium">Bautizado en la Pquia.</label><input name="bautizadoEn" type="text" id="c-bautizado-en" class="mt-1 block w-full rounded-md p-2 border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700" required></div>
                        <div><label for="c-bautizado-diocesis" class="block text-sm font-medium">Diócesis (Bautismo)</label><input name="bautizadoDiocesis" type="text" id="c-bautizado-diocesis" class="mt-1 block w-full rounded-md p-2 border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700" required></div>
                        <div class="md:col-span-2"></div>
                        <div><label for="c-bautizado-libro" class="block text-sm font-medium">Libro (Bautismo)</label><input name="bautizadoLibro" type="text" id="c-bautizado-libro" class="mt-1 block w-full rounded-md p-2 border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700" required></div>
                        <div><label for="c-bautizado-folio" class="block text-sm font-medium">Folio (Bautismo)</label><input name="bautizadoFolio" type="text" id="c-bautizado-folio" class="mt-1 block w-full rounded-md p-2 border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700" required></div>

                        <div class="md:col-span-2 flex justify-end space-x-4 mt-6">
                            <button type="button" data-action="generate-certificate" data-type="confirmacion" data-format="pdf" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg flex items-center space-x-2">
                                <i data-feather="download" class="h-4 w-4"></i>
                                <span>Descargar PDF</span>
                            </button>
                            <button type="submit" data-action="generate-certificate" data-type="confirmacion" data-format="print" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg flex items-center space-x-2">
                                <i data-feather="printer" class="h-4 w-4"></i>
                                <span>Generar e Imprimir</span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </section>
        
        <!-- MÓDULO ORGANIZACIÓN DE MISAS -->
        <section id="mass-org-content" data-view="mass-org-content" class="hidden min-h-screen">
            <div class="container mx-auto px-6 py-12">
                <div class="flex justify-between items-center mb-8 no-print">
                    <h2 class="text-3xl font-bold">Organización de Misas y Ministros</h2>
                    <div>
                        <button data-action="print-mass-org" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg mr-4">Imprimir</button>
                        <button data-action="show-view" data-view-id="secretaria-dashboard" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg">Inicio</button>
                    </div>
                </div>
                <div id="mass-org-print-area" class="space-y-12 printable-area">
                    <!-- Tabla de Ministros -->
                    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-8">
                        <h3 class="text-2xl font-bold mb-4">Organización para el servicio litúrgico (Ministros)</h3>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                                <thead class="bg-gray-50 dark:bg-gray-700">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium uppercase">Semanas</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium uppercase">Sábado 19:30 H</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium uppercase">Domingo 08:00 H</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium uppercase">Domingo 10:30 H</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium uppercase">Domingo 20:00 H</th>
                                        <th class="px-6 py-3 text-center text-xs font-medium uppercase no-print">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="ministros-table-body" class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700"></tbody>
                            </table>
                        </div>
                        <div class="mt-4 text-right no-print"><button data-action="add-row" data-table="ministros" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">Agregar Fila</button></div>
                    </div>

                    <!-- Tabla de Organización de Misas -->
                    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-8">
                        <h3 class="text-2xl font-bold mb-4">Organización de las Misas (Grupos)</h3>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                                <thead class="bg-gray-50 dark:bg-gray-700">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium uppercase">Semanas</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium uppercase">Sábado 19:30 H</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium uppercase">Domingo 08:00 H</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium uppercase">Domingo 10:30 H</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium uppercase">Domingo 19:30 H</th>
                                        <th class="px-6 py-3 text-center text-xs font-medium uppercase no-print">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="grupos-table-body" class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700"></tbody>
                            </table>
                        </div>
                        <div class="mt-4 text-right no-print"><button data-action="add-row" data-table="grupos" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">Agregar Fila</button></div>
                    </div>
                </div>
            </div>
        </section>

        <!-- MÓDULO DE NOTIFICACIONES -->
        <section id="notifications-content" data-view="notifications-content" class="hidden min-h-screen">
           <div class="container mx-auto px-6 py-12">
                <div class="flex justify-between items-center mb-8">
                    <h2 class="text-3xl font-bold">Notificaciones y Recordatorios</h2>
                    <button data-action="show-view" data-view-id="secretaria-dashboard" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg">Inicio</button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                    <div class="md:col-span-1">
                        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-8">
                            <h3 class="text-xl font-bold mb-4">Nueva Notificación</h3>
                            <form id="notification-form" class="space-y-4">
                                <textarea id="notification-text" rows="4" class="w-full rounded-md p-2 border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700" placeholder="Escribe tu recordatorio aquí..." required></textarea>
                                <div>
                                    <label for="notification-priority" class="block text-sm font-medium">Prioridad</label>
                                    <select id="notification-priority" class="mt-1 block w-full rounded-md p-2 border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700">
                                        <option value="normal">Normal</option>
                                        <option value="importante">Importante</option>
                                        <option value="urgente">Urgente</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="notification-due-date" class="block text-sm font-medium">Fecha de Vencimiento</label>
                                    <input type="date" id="notification-due-date" class="mt-1 block w-full rounded-md p-2 border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700">
                                </div>
                                <button type="submit" class="mt-4 w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">Agregar</button>
                            </form>
                        </div>
                    </div>
                    <div class="md:col-span-2">
                        <div id="notifications-list" class="space-y-4"></div>
                    </div>
                </div>
           </div>
        </section>

        <!-- MÓDULO DE CORREO -->
        <section id="email-content" data-view="email-content" class="hidden min-h-screen">
             <div class="container mx-auto px-6 py-12">
                <div class="flex justify-between items-center mb-8">
                    <h2 class="text-3xl font-bold">Cliente de Correo</h2>
                    <button data-action="show-view" data-view-id="secretaria-dashboard" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg">Inicio</button>
                </div>
                <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-8">
                    <div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 mb-6 rounded-r-lg" role="alert">
                      <p class="font-bold">Advertencia de Seguridad</p>
                      <p>Esta es una interfaz de demostración. Para una solución real, se debe implementar un método de autenticación seguro como OAuth 2.0.</p>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 items-end">
                        <div><label for="email-address" class="block text-sm font-medium">Correo de Gmail</label><input type="email" id="email-address" class="mt-1 block w-full rounded-md p-2 border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700" placeholder="ejemplo@gmail.com"></div>
                        <div><label for="email-password" class="block text-sm font-medium">Contraseña</label><input type="password" id="email-password" class="mt-1 block w-full rounded-md p-2 border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700"></div>
                        <div><button class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">Conectar (Simulación)</button></div>
                    </div>
                    <div class="mt-8 border-t pt-8">
                        <h3 class="text-xl font-bold mb-4">Bandeja de Entrada (Simulación)</h3>
                        <div class="border rounded-lg overflow-hidden">
                            <div class="p-4 border-b hover:bg-gray-50 dark:hover:bg-gray-700 cursor-pointer"><p class="font-bold">Juan Perez</p><p class="text-sm text-gray-600 dark:text-gray-400">Consulta sobre horarios de bautismo</p></div>
                            <div class="p-4 border-b hover:bg-gray-50 dark:hover:bg-gray-700 cursor-pointer"><p class="font-bold">Maria Gomez</p><p class="text-sm text-gray-600 dark:text-gray-400">Donación para Cáritas</p></div>
                        </div>
                    </div>
                </div>
             </div>
        </section>
    </main>

    <!-- Edit Row Modal -->
    <div id="edit-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center p-4 no-print z-50">
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-8 w-full max-w-lg">
            <h3 id="edit-modal-title" class="text-2xl font-bold mb-6">Modificar Fila</h3>
            <form id="edit-form">
                <input type="hidden" id="edit-id">
                <input type="hidden" id="edit-table">
                <div class="space-y-4">
                    <div><label for="edit-semana" class="block text-sm font-medium">Semanas</label><input type="text" id="edit-semana" class="mt-1 block w-full rounded-md p-2 border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700"></div>
                    <div><label for="edit-sabado" class="block text-sm font-medium">Sábado 19:30 H</label><input type="text" id="edit-sabado" class="mt-1 block w-full rounded-md p-2 border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700"></div>
                    <div><label for="edit-dom08" class="block text-sm font-medium">Domingo 08:00 H</label><input type="text" id="edit-dom08" class="mt-1 block w-full rounded-md p-2 border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700"></div>
                    <div><label for="edit-dom10" class="block text-sm font-medium">Domingo 10:30 H</label><input type="text" id="edit-dom10" class="mt-1 block w-full rounded-md p-2 border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700"></div>
                    <div><label for="edit-dom20" class="block text-sm font-medium">Domingo 20:00 H</label><input type="text" id="edit-dom20" class="mt-1 block w-full rounded-md p-2 border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700"></div>
                </div>
                <div class="mt-8 flex justify-end space-x-4">
                    <button type="button" data-action="close-edit-modal" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg">Cancelar</button>
                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">Guardar Cambios</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Custom Location Modal -->
    <div id="custom-location-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center p-4 no-print z-50">
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-8 w-full max-w-md">
            <h3 class="text-2xl font-bold mb-6">Ingresar Lugar de Expedición</h3>
            <form id="custom-location-form">
                <div class="space-y-4">
                    <div>
                        <label for="custom-location-input" class="block text-sm font-medium">Lugar</label>
                        <input type="text" id="custom-location-input" class="mt-1 block w-full rounded-md p-2 border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700" required>
                    </div>
                </div>
                <div class="mt-8 flex justify-end space-x-4">
                    <button type="button" data-action="close-custom-location-modal" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg">Volver</button>
                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">Confirmar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="delete-confirm-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center p-4 no-print z-50">
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-8 w-full max-w-md">
            <h3 class="text-xl font-bold mb-4">Confirmar Eliminación</h3>
            <p>¿Estás seguro de que deseas eliminar este registro? Esta acción no se puede deshacer.</p>
            <div class="mt-8 flex justify-end space-x-4">
                <button type="button" data-action="cancel-delete" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg">Cancelar</button>
                <button type="button" data-action="confirm-delete" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">Eliminar</button>
            </div>
        </div>
    </div>

    <!-- Loading Spinner -->
    <div id="loading-spinner" class="hidden fixed inset-0 bg-black bg-opacity-60 flex justify-center items-center z-50">
        <div class="spinner h-16 w-16 border-4 rounded-full"></div>
    </div>

    <!-- Toast Container -->
    <div id="toast-container" class="fixed bottom-4 right-4 z-50 space-y-2"></div>

    <div id="print-container" class="hidden printable-area"></div>

    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyD7Exbyew-eGESZHdfetzkFDt5BJxLgPlE",
            authDomain: "secretariaparroquial-c8c72.firebaseapp.com",
            projectId: "secretariaparroquial-c8c72",
            storageBucket: "secretariaparroquial-c8c72.appspot.com",
            messagingSenderId: "850332198124",
            appId: "1:850332198124:web:7eb4e148087d336dbfb1c9"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);

        // --- MAIN APP LOGIC ---
        document.addEventListener('DOMContentLoaded', () => {
            
            let recordToDelete = { type: null, id: null };

            const appState = {
                notifications: [
                    { id: 1, text: "Recordar reunión de Cáritas el próximo Jueves a las 18:00 hs.", priority: 'importante', dueDate: '2025-08-14' },
                    { id: 2, text: "Confirmar asistencia de los ministros para la misa del Domingo.", priority: 'urgente', dueDate: '2025-08-10' },
                    { id: 3, text: "Comprar nuevas velas para el altar.", priority: 'normal', dueDate: '' }
                ],
                ministros: [
                    { id: 1, semana: 'Primero', sabado: 'Laura Alvez', dom08: 'Raúl Segovia', dom10: '', dom20: 'Jorge Giménez' },
                    { id: 2, semana: 'Segundo', sabado: 'Estela Santia', dom08: '', dom10: 'Jorge Gimenez', dom20: 'Maritel Reyero' },
                    { id: 3, semana: 'Tercero', sabado: 'Raul Segovia', dom08: '', dom10: '', dom20: 'Raul Segovia' },
                    { id: 4, semana: 'Cuarto', sabado: 'Maritel Reyero', dom08: '', dom10: 'Raul Segovia', dom20: 'Estela Santia' },
                    { id: 5, semana: 'Quinto', sabado: 'Jorge Giménez', dom08: '', dom10: '', dom20: 'Laura Alvez' }
                ],
                grupos: [
                    { id: 1, semana: 'Primero', sabado: 'Legión de María', dom08: 'Nora y Silvana', dom10: 'Jardín Semillitas', dom20: 'Taller de oracion y vida' },
                    { id: 2, semana: 'Segundo', sabado: 'Colegio San José (Secundario)', dom08: 'Polaqui y Rita', dom10: 'Instituto Niño Jesús', dom20: 'CAE' },
                    { id: 3, semana: 'Tercero', sabado: 'Renovación Carismática', dom08: 'Estela Y Mónica', dom10: 'Catequesis', dom20: 'Hogares Nuevos' },
                    { id: 4, semana: 'Cuarto', sabado: 'Cáritas', dom08: 'Liliana', dom10: 'Colegio San José (Primario)', dom20: 'Jesús Misericordioso' },
                    { id: 5, semana: 'Quinto', sabado: 'Estela Santia', dom08: 'Paula', dom10: 'Catequesis', dom20: 'Apostolado de la Oración' }
                ],
                bautismos: [],
                confirmaciones: [],
                bautismosSearchTerm: '',
                bautismosCurrentPage: 1,
                confirmacionesSearchTerm: '',
                confirmacionesCurrentPage: 1,
                recordsPerPage: 3,
            };

            const dom = {
                loginView: document.getElementById('login-view'),
                appContainer: document.getElementById('app-container'),
                loginForm: document.getElementById('login-form'),
                logoutBtn: document.getElementById('logout-btn'),
                togglePasswordBtn: document.getElementById('toggle-password'),
                views: document.querySelectorAll('[data-view]'),
                printContainer: document.getElementById('print-container'),
                notificationsList: document.getElementById('notifications-list'),
                notificationForm: document.getElementById('notification-form'),
                ministrosTableBody: document.getElementById('ministros-table-body'),
                gruposTableBody: document.getElementById('grupos-table-body'),
                baptismForm: document.getElementById('baptism-form'),
                confirmationForm: document.getElementById('confirmation-form'),
                editModal: document.getElementById('edit-modal'),
                editModalTitle: document.getElementById('edit-modal-title'),
                editForm: document.getElementById('edit-form'),
                customLocationModal: document.getElementById('custom-location-modal'),
                customLocationForm: document.getElementById('custom-location-form'),
                lugarSelect: document.getElementById('c-lugar-select'),
                hiddenLugarInput: document.getElementById('c-lugar-expedicion-hidden'),
                bautismoRecordsContainer: document.getElementById('bautismo-records-container'),
                bautismoPaginationContainer: document.getElementById('bautismo-pagination-container'),
                bautismoSearchInput: document.getElementById('bautismo-search'),
                confirmacionRecordsContainer: document.getElementById('confirmacion-records-container'),
                confirmacionPaginationContainer: document.getElementById('confirmacion-pagination-container'),
                confirmacionSearchInput: document.getElementById('confirmacion-search'),
                deleteConfirmModal: document.getElementById('delete-confirm-modal'),
                notificationBadge: document.getElementById('notification-badge'),
                loadingSpinner: document.getElementById('loading-spinner'),
                toastContainer: document.getElementById('toast-container'),
            };

            const showSpinner = () => dom.loadingSpinner.classList.remove('hidden');
            const hideSpinner = () => dom.loadingSpinner.classList.add('hidden');

            const showToast = (message, type = 'success') => {
                const toast = document.createElement('div');
                const bgColor = type === 'success' ? 'bg-green-500' : 'bg-red-500';
                toast.className = `toast text-white px-6 py-3 rounded-lg shadow-lg ${bgColor}`;
                toast.textContent = message;
                dom.toastContainer.appendChild(toast);
                setTimeout(() => {
                    toast.remove();
                }, 3500);
            };

            const updateNotificationBell = () => {
                const alertCount = appState.notifications.filter(n => n.priority === 'importante' || n.priority === 'urgente').length;
                if (alertCount > 0) {
                    dom.notificationBadge.textContent = alertCount;
                    dom.notificationBadge.classList.remove('hidden');
                } else {
                    dom.notificationBadge.classList.add('hidden');
                }
            };

            const renderNotifications = () => {
                const priorityClasses = {
                    normal: 'border-gray-200 dark:border-gray-700',
                    importante: 'border-yellow-500',
                    urgente: 'border-red-500',
                };
                const today = new Date();
                today.setHours(0, 0, 0, 0);

                dom.notificationsList.innerHTML = appState.notifications.map(n => {
                    const isOverdue = n.dueDate && new Date(n.dueDate) < today;
                    const dateColor = isOverdue ? 'text-red-500' : 'text-gray-500 dark:text-gray-400';
                    return `
                    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-6 border-l-4 ${priorityClasses[n.priority]}">
                        <div class="flex justify-between items-start">
                            <p class="text-gray-800 dark:text-gray-200">${n.text}</p>
                            <button data-action="remove-notification" data-id="${n.id}" class="text-red-500 hover:text-red-700 no-print ml-4">
                                <i data-feather="trash-2" class="h-4 w-4"></i>
                            </button>
                        </div>
                        ${n.dueDate ? `<p class="text-sm mt-2 ${dateColor}">Vence: ${formatDate(n.dueDate)}</p>` : ''}
                    </div>
                `}).join('');
                feather.replace();
                updateNotificationBell();
            };

            const renderTable = (tableKey, tbodyElement) => {
                tbodyElement.innerHTML = appState[tableKey].map(row => `
                    <tr data-id="${row.id}">
                        <td class="px-6 py-4">${row.semana}</td>
                        <td class="px-6 py-4">${row.sabado}</td>
                        <td class="px-6 py-4">${row.dom08}</td>
                        <td class="px-6 py-4">${row.dom10}</td>
                        <td class="px-6 py-4">${row.dom20}</td>
                        <td class="px-6 py-4 text-center no-print">
                            <div class="flex justify-center items-center space-x-2">
                                <button data-action="show-edit-modal" data-table="${tableKey}" data-id="${row.id}" class="text-blue-500 hover:text-blue-700 p-1">
                                    <i data-feather="edit" class="h-4 w-4"></i>
                                </button>
                                <button data-action="remove-row" data-table="${tableKey}" data-id="${row.id}" class="text-red-500 hover:text-red-700 p-1">
                                    <i data-feather="trash-2" class="h-4 w-4"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `).join('');
            };

            const renderRecords = (type) => {
                const isBautismo = type === 'bautismo';
                const records = isBautismo ? appState.bautismos : appState.confirmaciones;
                const searchTerm = (isBautismo ? appState.bautismosSearchTerm : appState.confirmacionesSearchTerm).toLowerCase();
                const container = isBautismo ? dom.bautismoRecordsContainer : dom.confirmacionRecordsContainer;
                const paginationContainer = isBautismo ? dom.bautismoPaginationContainer : dom.confirmacionPaginationContainer;
                let currentPage = isBautismo ? appState.bautismosCurrentPage : appState.confirmacionesCurrentPage;

                const filteredRecords = records.filter(r => {
                    if (!searchTerm) return true;
                    const searchIn = [r.nombre, r.fechaBautismo, r.fechaConfirmacion, r.padre, r.madre, r.padrino, r.madrina].join(' ').toLowerCase();
                    return searchIn.includes(searchTerm);
                }).sort((a, b) => b.generatedAt - a.generatedAt);

                const totalPages = Math.ceil(filteredRecords.length / appState.recordsPerPage);
                if (currentPage > totalPages) currentPage = totalPages || 1;
                if (isBautismo) appState.bautismosCurrentPage = currentPage; else appState.confirmacionesCurrentPage = currentPage;

                const start = (currentPage - 1) * appState.recordsPerPage;
                const end = start + appState.recordsPerPage;
                const paginatedRecords = filteredRecords.slice(start, end);

                if (paginatedRecords.length === 0) {
                    container.innerHTML = `<p class="text-gray-500 dark:text-gray-400 italic">No hay registros para mostrar.</p>`;
                } else {
                    container.innerHTML = paginatedRecords.map(r => `
                        <div class="bg-white dark:bg-gray-800 rounded-lg p-3 shadow flex justify-between items-center">
                            <div>
                                <p class="font-bold">${r.nombre}</p>
                                <p class="text-sm text-gray-600 dark:text-gray-400">Fecha: ${isBautismo ? formatDate(r.fechaBautismo) : formatDate(r.fechaConfirmacion)}</p>
                            </div>
                            <div class="flex items-center space-x-2">
                                <button data-action="edit-record" data-type="${type}" data-id="${r.id}" class="text-blue-500 hover:text-blue-700 p-1" title="Modificar"><i data-feather="edit" class="h-4 w-4"></i></button>
                                <button data-action="download-record-pdf" data-type="${type}" data-id="${r.id}" class="text-green-500 hover:text-green-700 p-1" title="Descargar PDF"><i data-feather="download" class="h-4 w-4"></i></button>
                                <button data-action="delete-record" data-type="${type}" data-id="${r.id}" class="text-red-500 hover:text-red-700 p-1" title="Eliminar"><i data-feather="trash-2" class="h-4 w-4"></i></button>
                            </div>
                        </div>
                    `).join('');
                }

                paginationContainer.innerHTML = `
                    <button data-action="paginate" data-type="${type}" data-direction="prev" class="px-3 py-1 bg-gray-200 dark:bg-gray-700 rounded ${currentPage === 1 ? 'opacity-50 cursor-not-allowed' : ''}" ${currentPage === 1 ? 'disabled' : ''}>Anterior</button>
                    <span class="text-sm text-gray-600 dark:text-gray-400">Página ${currentPage} de ${totalPages || 1}</span>
                    <button data-action="paginate" data-type="${type}" data-direction="next" class="px-3 py-1 bg-gray-200 dark:bg-gray-700 rounded ${currentPage === totalPages || totalPages === 0 ? 'opacity-50 cursor-not-allowed' : ''}" ${currentPage === totalPages || totalPages === 0 ? 'disabled' : ''}>Siguiente</button>
                `;
                feather.replace();
            };
            
            const renderAll = () => {
                renderNotifications();
                renderTable('ministros', dom.ministrosTableBody);
                renderTable('grupos', dom.gruposTableBody);
                renderRecords('bautismo');
                renderRecords('confirmacion');
                feather.replace();
            };

            const showView = (viewId) => {
                dom.views.forEach(view => {
                    view.classList.toggle('hidden', view.dataset.view !== viewId);
                });
                if (viewId === 'bautismo-content') dom.baptismForm.reset();
                if (viewId === 'confirmacion-content') {
                    dom.confirmationForm.reset();
                    const today = new Date().toISOString().split('T')[0];
                    document.getElementById('c-fecha-expedicion').value = today;
                }
                if (viewId === 'certificate-choice-content') {
                    renderRecords('bautismo');
                    renderRecords('confirmacion');
                }
                feather.replace();
            };

            const showEditModal = (table, id) => {
                const rowData = appState[table].find(row => row.id === parseInt(id));
                if (!rowData) return;
                dom.editModalTitle.innerText = `Modificar Fila de ${table === 'ministros' ? 'Ministros' : 'Grupos'}`;
                dom.editForm.querySelector('#edit-id').value = rowData.id;
                dom.editForm.querySelector('#edit-table').value = table;
                dom.editForm.querySelector('#edit-semana').value = rowData.semana;
                dom.editForm.querySelector('#edit-sabado').value = rowData.sabado;
                dom.editForm.querySelector('#edit-dom08').value = rowData.dom08;
                dom.editForm.querySelector('#edit-dom10').value = rowData.dom10;
                dom.editForm.querySelector('#edit-dom20').value = rowData.dom20;
                dom.editModal.classList.remove('hidden');
            };

            const closeEditModal = () => dom.editModal.classList.add('hidden');
            const closeCustomLocationModal = () => {
                dom.customLocationModal.classList.add('hidden');
                dom.lugarSelect.value = dom.hiddenLugarInput.value;
            };

            const handleCertificateAction = async (type, format, existingData = null) => {
                const form = type === 'bautismo' ? dom.baptismForm : dom.confirmationForm;
                let formData;

                if (existingData) {
                    formData = existingData;
                } else {
                    if (!form.checkValidity()) {
                        form.reportValidity();
                        return;
                    }
                    formData = Object.fromEntries(new FormData(form).entries());
                    
                    const recordId = formData.id ? parseInt(formData.id) : null;
                    const recordArray = type === 'bautismo' ? appState.bautismos : appState.confirmaciones;
                    
                    if (recordId && recordId !== 'null' && recordId !== '') { // Update existing record
                        const index = recordArray.findIndex(r => r.id === recordId);
                        if (index !== -1) {
                            recordArray[index] = { ...recordArray[index], ...formData, id: recordId };
                            showToast('Registro actualizado con éxito');
                        }
                    } else { // Create new record
                        const newRecord = { ...formData, id: Date.now(), generatedAt: new Date() };
                        recordArray.push(newRecord);
                        showToast('Registro guardado con éxito');
                    }
                }

                showSpinner();
                const certificateHTML = getCertificateHTML(type, formData);
                if (!certificateHTML) {
                    hideSpinner();
                    showToast('Error al crear el HTML del certificado', 'error');
                    return;
                }

                const certNode = document.createElement('div');
                certNode.innerHTML = certificateHTML;
                const elementToRender = certNode.firstChild;
                elementToRender.style.position = 'absolute';
                elementToRender.style.left = '-9999px';
                document.body.appendChild(elementToRender);

                try {
                    if (format === 'pdf') {
                        const { jsPDF } = window.jspdf;
                        const canvas = await html2canvas(elementToRender, { scale: 3 });
                        const imgData = canvas.toDataURL('image/png');
                        const pdf = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4' });
                        pdf.addImage(imgData, 'PNG', 0, 0, 210, 297);
                        pdf.save(`Certificado_${type}_${formData.nombre.replace(/ /g, '_')}.pdf`);
                        showToast('PDF generado con éxito');
                    } else {
                        dom.printContainer.innerHTML = certificateHTML;
                        window.print();
                        dom.printContainer.innerHTML = '';
                    }
                } catch (error) {
                    console.error("Error generating document:", error);
                    showToast('Error al generar el documento', 'error');
                } finally {
                    hideSpinner();
                    document.body.removeChild(elementToRender);
                    if (!existingData) {
                        form.reset();
                         if (type === 'confirmacion') {
                            const today = new Date().toISOString().split('T')[0];
                            document.getElementById('c-fecha-expedicion').value = today;
                            document.getElementById('c-lugar-expedicion-hidden').value = "Paso de los Libres, Corrientes";
                            document.getElementById('c-lugar-select').value = "Paso de los Libres, Corrientes";
                        }
                    }
                }
            };

            const formatDate = (dateString, format = 'short') => {
                if (!dateString) return '';
                const date = new Date(dateString);
                const options = { timeZone: 'UTC' };
                if (format === 'long') {
                    options.day = 'numeric';
                    options.month = 'long';
                    options.year = 'numeric';
                    return date.toLocaleDateString('es-AR', options);
                }
                 if (format === 'long_parts') {
                    const day = date.getUTCDate();
                    const month = date.toLocaleDateString('es-AR', { month: 'long', timeZone: 'UTC' });
                    const year = date.getUTCFullYear();
                    return `a los ${day} días del mes de ${month} de ${year}`;
                }
                return date.toLocaleDateString('es-AR', options);
            };

            const getCertificateHTML = (type, data) => {
                if (type === 'bautismo') {
                    const header = `<div class="certificate-modern-header"><h3>CERTIFICADO DE BAUTISMO</h3><p>Diócesis de Santo Tomé - Paso de los Libres – Corrientes<br>Dirección: Bartolomé Mitre 940<br>WhatsApp (3772) 651931</p></div>`;
                    const body = `<div class="certificate-modern-body"><p>Se certifica que en el libro N° <span class="field">${data.libro || ''}</span>, Folio N° <span class="field">${data.folio || ''}</span>, se encuentra la partida de Bautismo de: <strong>${(data.nombre || '').toUpperCase()}</strong>, nacido/a en <span class="field">${data.lugarNac || ''}</span> el <span class="field">${formatDate(data.fechaNac)}</span>, hijo/a de <span class="field">${data.padre || ''}</span> y de <span class="field">${data.madre || ''}</span>. Fue bautizado/a el día <span class="field">${formatDate(data.fechaBautismo)}</span>, siendo sus padrinos <span class="field">${data.padrino || ''}</span> y <span class="field">${data.madrina || ''}</span>.</p><p><strong>Notas:</strong> ${data.notas || 'Ninguna'}</p></div>`;
                    const footer = `<div class="certificate-modern-footer"><div class="signature-line">Sello Parroquial</div><div class="signature-line">Firma del Párroco</div></div>`;
                    return `<div class="pdf-page-container"><div class="certificate-modern">${header}${body}${footer}</div></div>`;
                }
                
                if (type === 'confirmacion') {
                    const mainCert = `
                        <div class="certificate-modern" style="height: 140mm; flex-grow: 0;">
                            <div class="certificate-modern-header">
                                <h3>CERTIFICADO DE CONFIRMACIÓN</h3>
                                <p>DIOCESIS DE SANTO TOME CORRIENTES</p>
                                <p><b>Parroquia:</b> San José</p>
                                <p><b>Localidad:</b> Paso de los Libres, Corrientes</p>
                            </div>
                            <div class="certificate-modern-body">
                                <p>Certifico que: <strong>${(data.nombre || '').toUpperCase()}</strong></p>
                                <p>hijo(a) de <span class="field">${data.padre || ''}</span> y de <span class="field">${data.madre || ''}</span> 
                                ha recibido solemnemente el Sacramento de la Confirmación en esta parroquia el día ${formatDate(data.fechaConfirmacion, 'long')}.</p>
                                <p>Registrado en el Libro Parroquial de Confirmaciones, página <span class="field">${data.pagina || ''}</span>, acta Nº <span class="field">${data.acta || ''}</span>.</p>
                                <p>En <span class="field">${data.lugarExpedicion || ''}</span>, ${formatDate(data.fechaExpedicion, 'long_parts')}.</p>
                            </div>
                            <div class="certificate-modern-footer">
                                <div class="signature-line">Sello parroquial</div>
                                <div class="signature-line">Pbro. ${data.parroco || ''} <br> Párroco</div>
                            </div>
                        </div>`;
                    
                    const notificationBox = `
                        <div class="notification-box">
                            <h4>DIOCESIS DE SANTO TOME-CORRIENTES</h4>
                            <p>Parroquia:<span class="field-line">San José</span></p>
                            <p>Localidad:<span class="field-line">Paso de los Libres, Corrientes</span></p>
                            <h4 style="margin-top: 5mm;">NOTIFICACION DE CONFIRMACION</h4>
                            <p>Nombre y Apellido:<span class="field-line">${data.nombre || ''}</span></p>
                            <p>Bautizado en la Pquia.:<span class="field-line">${data.bautizadoEn || ''}</span></p>
                            <div style="display: flex; gap: 10px;">
                                <p>L.<span class="field-line">${data.bautizadoLibro || ''}</span></p>
                                <p>F.<span class="field-line">${data.bautizadoFolio || ''}</span></p>
                            </div>
                            <p>Diócesis:<span class="field-line">${data.bautizadoDiocesis || ''}</span></p>
                            <p>Fue Confirmado el:<span class="field-line">${formatDate(data.fechaConfirmacion)}</span></p>
                            <p>Registrado en L.<span class="field-line">${data.pagina || ''}</span> F.<span class="field-line">${data.acta || ''}</span></p>
                            <div style="display: flex; justify-content: space-between; margin-top: 10mm;">
                                <span>Sello</span>
                                <span>Párroco</span>
                            </div>
                            <p class="footer-note">PARA ENVIAR A LA PARROQUIA DONDE SE CONFIRIO EL BAUTISMO</p>
                        </div>`;

                    const fichaBox = `
                        <div class="notification-box">
                            <h4>DIOCESIS DE SANTO TOME-CORRIENTES</h4>
                            <p>Parroquia:<span class="field-line">San José</span></p>
                            <p>Localidad:<span class="field-line">Paso de los Libres, Corrientes</span></p>
                            <h4 style="margin-top: 5mm;">FICHA DE CONFIRMACION</h4>
                            <p>Nombre y Apellido:<span class="field-line">${data.nombre || ''}</span></p>
                            <p>Bautizado en la Pquia.:<span class="field-line">${data.bautizadoEn || ''}</span></p>
                            <div style="display: flex; gap: 10px;">
                                <p>L.<span class="field-line">${data.bautizadoLibro || ''}</span></p>
                                <p>F.<span class="field-line">${data.bautizadoFolio || ''}</span></p>
                            </div>
                            <p>Padre:<span class="field-line">${data.padre || ''}</span></p>
                            <p>Madre:<span class="field-line">${data.madre || ''}</span></p>
                            <p>Padrino/Madrina:<span class="field-line">${data.padrino || ''}</span></p>
                            <p>Fecha:<span class="field-line">${formatDate(data.fechaConfirmacion)}</span></p>
                            <p>Ministro:<span class="field-line">${data.parroco || ''}</span></p>
                            <p class="footer-note">PARA INSCRIBIR EN EL LIBRO PARROQUIAL DE CONFIRMACIONES</p>
                        </div>`;

                    return `<div class="pdf-page-container">${mainCert}<div class="notification-container">${notificationBox}${fichaBox}</div></div>`;
                }
                return '';
            };

            const populateFormWithRecord = (type, id) => {
                const isBautismo = type === 'bautismo';
                const record = isBautismo ? appState.bautismos.find(r => r.id === id) : appState.confirmaciones.find(r => r.id === id);
                if (!record) return;

                const form = isBautismo ? dom.baptismForm : dom.confirmationForm;
                form.reset();
                Object.keys(record).forEach(key => {
                    const input = form.querySelector(`[name="${key}"]`);
                    if (input) {
                        input.value = record[key];
                    }
                });
                showView(isBautismo ? 'bautismo-content' : 'confirmacion-content');
            };

            document.body.addEventListener('click', (e) => {
                const target = e.target.closest('[data-action]');
                if (!target) return;
                const { action, viewId, table, id, type, format, direction } = target.dataset;
                switch (action) {
                    case 'show-view': showView(viewId); break;
                    case 'print-mass-org': window.print(); break;
                    case 'show-edit-modal': showEditModal(table, id); break;
                    case 'close-edit-modal': closeEditModal(); break;
                    case 'close-custom-location-modal': closeCustomLocationModal(); break;
                    case 'add-row':
                        const newId = Date.now();
                        appState[table].push({ id: newId, semana: 'Nueva', sabado: '', dom08: '', dom10: '', dom20: '' });
                        renderTable(table, table === 'ministros' ? dom.ministrosTableBody : dom.gruposTableBody);
                        feather.replace();
                        break;
                    case 'remove-row':
                        appState[table] = appState[table].filter(row => row.id !== parseInt(id));
                        renderTable(table, table === 'ministros' ? dom.ministrosTableBody : dom.gruposTableBody);
                        feather.replace();
                        break;
                    case 'remove-notification':
                        appState.notifications = appState.notifications.filter(n => n.id !== parseInt(id));
                        renderNotifications();
                        showToast('Notificación eliminada');
                        break;
                    case 'generate-certificate':
                        e.preventDefault();
                        handleCertificateAction(type, format);
                        break;
                    case 'paginate':
                        if (type === 'bautismo') {
                            appState.bautismosCurrentPage += direction === 'next' ? 1 : -1;
                        } else {
                            appState.confirmacionesCurrentPage += direction === 'next' ? 1 : -1;
                        }
                        renderRecords(type);
                        break;
                    case 'edit-record':
                        populateFormWithRecord(type, parseInt(id));
                        break;
                    case 'download-record-pdf':
                        const record = type === 'bautismo' ? appState.bautismos.find(r => r.id === parseInt(id)) : appState.confirmaciones.find(r => r.id === parseInt(id));
                        if(record) handleCertificateAction(type, 'pdf', record);
                        break;
                    case 'delete-record':
                        recordToDelete = { type, id: parseInt(id) };
                        dom.deleteConfirmModal.classList.remove('hidden');
                        break;
                    case 'cancel-delete':
                        dom.deleteConfirmModal.classList.add('hidden');
                        recordToDelete = { type: null, id: null };
                        break;
                    case 'confirm-delete':
                        if (recordToDelete.type && recordToDelete.id) {
                            const recordArray = recordToDelete.type === 'bautismo' ? 'bautismos' : 'confirmaciones';
                            appState[recordArray] = appState[recordArray].filter(r => r.id !== recordToDelete.id);
                            renderRecords(recordToDelete.type);
                            showToast('Registro eliminado con éxito');
                        }
                        dom.deleteConfirmModal.classList.add('hidden');
                        recordToDelete = { type: null, id: null };
                        break;
                }
            });

            dom.bautismoSearchInput.addEventListener('input', (e) => {
                appState.bautismosSearchTerm = e.target.value;
                appState.bautismosCurrentPage = 1;
                renderRecords('bautismo');
            });

            dom.confirmacionSearchInput.addEventListener('input', (e) => {
                appState.confirmacionesSearchTerm = e.target.value;
                appState.confirmacionesCurrentPage = 1;
                renderRecords('confirmacion');
            });

            dom.notificationForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const text = dom.notificationForm.querySelector('#notification-text').value.trim();
                const priority = dom.notificationForm.querySelector('#notification-priority').value;
                const dueDate = dom.notificationForm.querySelector('#notification-due-date').value;
                if (text) {
                    appState.notifications.unshift({ id: Date.now(), text, priority, dueDate });
                    renderNotifications();
                    dom.notificationForm.reset();
                    showToast('Notificación agregada');
                }
            });

            dom.editForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const id = parseInt(dom.editForm.querySelector('#edit-id').value);
                const table = dom.editForm.querySelector('#edit-table').value;
                const rowIndex = appState[table].findIndex(row => row.id === id);
                if (rowIndex === -1) return;
                appState[table][rowIndex] = {
                    id: id,
                    semana: dom.editForm.querySelector('#edit-semana').value,
                    sabado: dom.editForm.querySelector('#edit-sabado').value,
                    dom08: dom.editForm.querySelector('#edit-dom08').value,
                    dom10: dom.editForm.querySelector('#edit-dom10').value,
                    dom20: dom.editForm.querySelector('#edit-dom20').value,
                };
                renderTable(table, table === 'ministros' ? dom.ministrosTableBody : dom.gruposTableBody);
                feather.replace();
                closeEditModal();
            });

            dom.lugarSelect.addEventListener('change', () => {
                if (dom.lugarSelect.value === 'otro') {
                    dom.customLocationModal.classList.remove('hidden');
                    dom.customLocationModal.querySelector('#custom-location-input').focus();
                } else {
                    dom.hiddenLugarInput.value = dom.lugarSelect.value;
                }
            });

            dom.customLocationForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const input = dom.customLocationForm.querySelector('#custom-location-input');
                const customLocation = input.value.trim();
                if (customLocation) {
                    let existingOption = dom.lugarSelect.querySelector(`option[value="${customLocation}"]`);
                    if (!existingOption) {
                        const newOption = document.createElement('option');
                        newOption.value = customLocation;
                        newOption.textContent = customLocation;
                        dom.lugarSelect.insertBefore(newOption, dom.lugarSelect.querySelector('option[value="otro"]'));
                    }
                    dom.lugarSelect.value = customLocation;
                    dom.hiddenLugarInput.value = customLocation;
                    input.value = '';
                    closeCustomLocationModal();
                }
            });

            // --- AUTHENTICATION LOGIC ---
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    dom.loginView.classList.add('hidden');
                    dom.appContainer.classList.remove('hidden');
                    showView('secretaria-dashboard');
                    renderAll();
                } else {
                    dom.loginView.classList.remove('hidden');
                    dom.appContainer.classList.add('hidden');
                }
            });

            dom.loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = dom.loginForm.querySelector('#email').value;
                const password = dom.loginForm.querySelector('#password').value;
                showSpinner();
                try {
                    await signInWithEmailAndPassword(auth, email, password);
                    showToast('Inicio de sesión exitoso');
                } catch (error) {
                    console.error("Login error:", error.code);
                    showToast('Correo o contraseña incorrectos', 'error');
                } finally {
                    hideSpinner();
                }
            });

            dom.logoutBtn.addEventListener('click', async () => {
                await signOut(auth);
                showToast('Sesión cerrada');
            });

            dom.togglePasswordBtn.addEventListener('click', () => {
                const passwordInput = document.getElementById('password');
                const iconEye = dom.togglePasswordBtn.querySelector('.icon-eye');
                const iconEyeOff = dom.togglePasswordBtn.querySelector('.icon-eye-off');
                if (passwordInput.type === 'password') {
                    passwordInput.type = 'text';
                    iconEye.classList.add('hidden');
                    iconEyeOff.classList.remove('hidden');
                } else {
                    passwordInput.type = 'password';
                    iconEye.classList.remove('hidden');
                    iconEyeOff.classList.add('hidden');
                }
            });
        });
    </script>
</body>
</html>
