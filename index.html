<!DOCTYPE html>
<html lang="es" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Módulo de Secretaría - Parroquia San José</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Serif:wght@400;700&display=swap" rel="stylesheet">
    
    <script src="https://unpkg.com/feather-icons"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style id="app-styles">
        body { font-family: 'Inter', sans-serif; }
        .card-hover-effect { transition: transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out; }
        .card-hover-effect:hover { transform: translateY(-10px); box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1); }
        .hidden { display: none; }

        /* A4 Page container for PDF */
        .pdf-page-container {
            width: 210mm;
            height: 297mm;
            padding: 10mm;
            box-sizing: border-box;
            background-color: #fff;
            display: flex;
            flex-direction: column;
            font-family: 'Noto Serif', serif;
            color: #333;
        }

        /* Certificate Styles */
        .certificate-modern {
            border: 1px solid #e0e0e0;
            padding: 10mm;
            background-color: #f7f7f7;
        }
        .certificate-modern-header {
            text-align: center;
            border-bottom: 2px solid #a3804b;
            padding-bottom: 10px;
            margin-bottom: 10mm;
        }
        .certificate-modern-header h3 {
            font-size: 22pt;
            font-weight: 700;
            color: #a3804b;
            margin: 0;
            letter-spacing: 2px;
        }
        .certificate-modern-header p {
            font-family: 'Inter', sans-serif;
            font-size: 9pt;
            color: #555;
            margin: 2px 0;
            line-height: 1.5;
        }
        .certificate-modern-body {
            font-size: 11pt;
            line-height: 2.2;
            text-align: justify;
        }
        .certificate-modern-body strong {
            font-weight: 700;
            color: #000;
        }
        .certificate-modern-body .field {
            font-family: 'Inter', sans-serif;
            font-weight: 500;
            border-bottom: 1px dotted #888;
            padding: 0 8px;
        }
        .certificate-modern-footer {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            margin-top: 15mm;
            border-top: 1px solid #e0e0e0;
            padding-top: 10mm;
            font-family: 'Inter', sans-serif;
            font-size: 10pt;
        }
        .signature-line {
            border-top: 1px solid #555;
            width: 60mm;
            text-align: center;
            padding-top: 5px;
        }

        /* Notification & Ficha Box Styles */
        .notification-container {
            display: flex;
            gap: 10mm;
            margin-top: 10mm;
            flex-grow: 1;
        }
        .notification-box {
            border: 1px solid #ccc;
            padding: 5mm;
            flex: 1;
            font-size: 9pt;
            line-height: 1.8;
            display: flex;
            flex-direction: column;
        }
        .notification-box h4 {
            text-align: center;
            font-weight: bold;
            font-size: 10pt;
            margin-bottom: 5mm;
        }
        .notification-box .field-line {
            border-bottom: 1px dotted #888;
            flex-grow: 1;
            margin-left: 4px;
        }
        .notification-box p {
            display: flex;
        }
        .notification-box .footer-note {
            font-size: 7pt;
            text-align: center;
            margin-top: auto;
            padding-top: 5mm;
            font-style: italic;
        }
        
        /* MODIFICACIÓN: Estilo para campos editables */
        .editable-field {
            padding: 2px 6px;
            border-radius: 4px;
            background-color: rgba(0,0,0,0.05);
            transition: background-color 0.2s ease;
        }
        .dark .editable-field {
             background-color: rgba(255,255,255,0.1);
        }
        .editable-field:hover, .editable-field:focus {
            background-color: rgba(0,0,0,0.1);
            outline: none;
        }
         .dark .editable-field:hover, .dark .editable-field:focus {
             background-color: rgba(255,255,255,0.2);
        }

        /* Loading Spinner */
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .spinner {
            border-color: #fff;
            border-top-color: transparent;
            animation: spin 1s linear infinite;
        }

        /* Toast Notifications */
        @keyframes toast-in {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes toast-out {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }
        .toast {
            animation: toast-in 0.5s, toast-out 0.5s 3s;
        }

        /* Print-specific styles */
        @media print {
            body {
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            body > *:not(.print-only) {
                display: none !important;
            }
            .print-only {
                display: block !important;
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
            }
            .no-print {
                display: none !important;
            }
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-slate-900 text-gray-800 dark:text-gray-200">

    <section id="login-view" class="min-h-screen flex items-center justify-center">
        <div class="bg-white dark:bg-gray-800 p-8 rounded-2xl shadow-lg w-full max-w-md">
            <h2 class="text-3xl font-bold text-center mb-2">Secretaría Parroquial</h2>
            <p class="text-center text-gray-600 dark:text-gray-400 mb-8">Acceso</p>
            <form id="login-form" class="space-y-6">
                <div>
                    <input type="email" id="email" placeholder="Correo" class="block w-full rounded-lg py-3 px-4 border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 text-center" required>
                </div>
                <div class="relative">
                    <input type="password" id="password" placeholder="Contraseña" class="block w-full rounded-lg py-3 px-4 border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 text-center" required>
                    <button type="button" id="toggle-password" class="absolute inset-y-0 right-0 px-4 flex items-center text-gray-500 dark:text-gray-300">
                        <i data-feather="eye" class="icon-eye"></i>
                        <i data-feather="eye-off" class="icon-eye-off hidden"></i>
                    </button>
                </div>
                <button type="submit" class="w-full bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white font-bold py-3 px-4 rounded-lg transition-all duration-300 ease-in-out transform hover:scale-105">Ingresar</button>
            </form>
        </div>
    </section>

    <main id="app-container" class="hidden">
        <section id="secretaria-dashboard" data-view="secretaria-dashboard" class="min-h-screen">
            <div class="container mx-auto px-6 py-20">
                <div class="flex justify-between items-center mb-12">
                    <h2 class="text-3xl font-bold">Secretaría Parroquia San José</h2>
                    <div class="flex items-center space-x-4">
                        <div id="notification-bell-container" class="relative cursor-pointer" data-action="show-view" data-view-id="notifications-content">
                            <i data-feather="bell" class="h-8 w-8 text-gray-600 dark:text-gray-300"></i>
                            <span id="notification-badge" class="hidden absolute -top-2 -right-2 bg-red-500 text-white text-xs font-bold rounded-full h-5 w-5 flex items-center justify-center"></span>
                        </div>
                        <button id="logout-btn" class="bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 text-white font-bold py-2 px-4 rounded-lg transition-all duration-300 ease-in-out transform hover:scale-105">Cerrar Sesión</button>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                    <div data-action="show-view" data-view-id="certificate-choice-content" class="card-hover-effect bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-8 flex flex-col items-center text-center cursor-pointer">
                        <div class="bg-indigo-100 dark:bg-indigo-900/30 p-4 rounded-full mb-6"><i data-feather="file-text" class="h-10 w-10 text-indigo-600 dark:text-indigo-400"></i></div>
                        <h3 class="text-2xl font-bold mb-2">Certificados</h3>
                        <p class="text-gray-600 dark:text-gray-400">Generar certificados de Bautismo y Confirmación.</p>
                    </div>
                    <div data-action="show-view" data-view-id="mass-org-content" class="card-hover-effect bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-8 flex flex-col items-center text-center cursor-pointer">
                        <div class="bg-teal-100 dark:bg-teal-900/30 p-4 rounded-full mb-6"><i data-feather="calendar" class="h-10 w-10 text-teal-600 dark:text-teal-400"></i></div>
                        <h3 class="text-2xl font-bold mb-2">Organización de Misas</h3>
                        <p class="text-gray-600 dark:text-gray-400">Gestionar horarios de misas y ministros.</p>
                    </div>
                    <div data-action="show-view" data-view-id="notifications-content" class="card-hover-effect bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-8 flex flex-col items-center text-center cursor-pointer">
                        <div class="bg-amber-100 dark:bg-amber-900/30 p-4 rounded-full mb-6"><i data-feather="bell" class="h-10 w-10 text-amber-600 dark:text-amber-400"></i></div>
                        <h3 class="text-2xl font-bold mb-2">Notificaciones</h3>
                        <p class="text-gray-600 dark:text-gray-400">Crear y ver recordatorios y anuncios internos.</p>
                    </div>
                </div>
            </div>
        </section>

        <section id="certificate-choice-content" data-view="certificate-choice-content" class="hidden min-h-screen">
            <div class="container mx-auto px-6 py-12">
                <div class="flex justify-between items-center mb-12">
                    <h2 class="text-3xl font-bold">Seleccionar Tipo de Certificado</h2>
                    <button data-action="show-view" data-view-id="secretaria-dashboard" class="bg-gradient-to-r from-gray-500 to-gray-600 hover:from-gray-600 hover:to-gray-700 text-white font-bold py-2 px-4 rounded-lg transition-all duration-300 ease-in-out transform hover:scale-105">Inicio</button>
                </div>
                <div class="flex justify-center">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-10 w-full max-w-4xl">
                        <div data-action="show-view" data-view-id="bautismo-content" class="card-hover-effect bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-8 flex flex-col items-center text-center cursor-pointer">
                            <div class="bg-sky-100 dark:bg-sky-900/30 p-4 rounded-full mb-6"><i data-feather="droplet" class="h-10 w-10 text-sky-600 dark:text-sky-400"></i></div>
                            <h2 class="text-2xl font-bold mb-2">Certificado de Bautismo</h2>
                            <p class="text-gray-600 dark:text-gray-400">Crear un nuevo certificado de bautismo.</p>
                        </div>
                        <div data-action="show-view" data-view-id="confirmacion-content" class="card-hover-effect bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-8 flex flex-col items-center text-center cursor-pointer">
                            <div class="bg-red-100 dark:bg-red-900/30 p-4 rounded-full mb-6"><i data-feather="wind" class="h-10 w-10 text-red-600 dark:text-red-400"></i></div>
                            <h2 class="text-2xl font-bold mb-2">Certificado de Confirmación</h2>
                            <p class="text-gray-600 dark:text-gray-400">Crear un nuevo certificado de confirmación.</p>
                        </div>
                    </div>
                </div>

                <div class="mt-16 grid grid-cols-1 lg:grid-cols-2 gap-12">
                    <div>
                        <h3 class="text-2xl font-bold mb-4">Últimos Registros de Bautismo</h3>
                        <div class="mb-4 relative">
                            <input type="search" id="bautismo-search" placeholder="Buscar por nombre, fecha, padrinos..." class="w-full rounded-md p-2 pl-10 border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 focus:ring-indigo-500 focus:border-indigo-500">
                            <i data-feather="search" class="absolute left-3 top-1/2 -translate-y-1/2 h-5 w-5 text-gray-400"></i>
                        </div>
                        <div id="bautismo-records-container" class="space-y-3"></div>
                        <div id="bautismo-pagination-container" class="mt-4 flex justify-between items-center"></div>
                    </div>
                    <div>
                        <h3 class="text-2xl font-bold mb-4">Últimos Registros de Confirmación</h3>
                        <div class="mb-4 relative">
                            <input type="search" id="confirmacion-search" placeholder="Buscar por nombre, fecha..." class="w-full rounded-md p-2 pl-10 border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 focus:ring-indigo-500 focus:border-indigo-500">
                                <i data-feather="search" class="absolute left-3 top-1/2 -translate-y-1/2 h-5 w-5 text-gray-400"></i>
                        </div>
                        <div id="confirmacion-records-container" class="space-y-3"></div>
                        <div id="confirmacion-pagination-container" class="mt-4 flex justify-between items-center"></div>
                    </div>
                </div>
            </div>
        </section>

        <section id="bautismo-content" data-view="bautismo-content" class="hidden min-h-screen">
            <div class="container mx-auto px-6 py-12">
                <div class="flex justify-between items-center mb-8">
                    <h2 class="text-3xl font-bold">Gestión de Certificados de Bautismo</h2>
                    <button data-action="show-view" data-view-id="certificate-choice-content" class="bg-gradient-to-r from-gray-500 to-gray-600 hover:from-gray-600 hover:to-gray-700 text-white font-bold py-2 px-4 rounded-lg transition-all duration-300 ease-in-out transform hover:scale-105">Volver a Elegir</button>
                </div>
                <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-8">
                    <form id="baptism-form" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <input type="hidden" name="id" id="b-id">
                        <h3 class="col-span-full text-xl font-bold text-gray-900 dark:text-white border-b pb-2">Datos del Certificado</h3>
                        <div><label for="b-libro" class="block text-sm font-medium">Libro N°</label><input name="libro" type="text" id="b-libro" class="mt-1 block w-full rounded-md p-2 border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700" required></div>
                        <div><label for="b-folio" class="block text-sm font-medium">Folio N°</label><input name="folio" type="text" id="b-folio" class="mt-1 block w-full rounded-md p-2 border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700" required></div>
                        <div class="md:col-span-2"><label for="b-nombre" class="block text-sm font-medium">Nombre y Apellido del Bautizado</label><input name="nombre" type="text" id="b-nombre" class="mt-1 block w-full rounded-md p-2 border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700" required></div>
                        <div><label for="b-dni" class="block text-sm font-medium">DNI</label><input name="dni" type="text" id="b-dni" class="mt-1 block w-full rounded-md p-2 border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700"></div>
                        <div><label for="b-fecha-nac" class="block text-sm font-medium">Fecha de Nacimiento</label><input name="fechaNac" type="date" id="b-fecha-nac" class="mt-1 block w-full rounded-md p-2 border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700" required></div>
                        <div class="md:col-span-2"><label for="b-lugar-nac" class="block text-sm font-medium">Nacido en</label><input name="lugarNac" type="text" id="b-lugar-nac" class="mt-1 block w-full rounded-md p-2 border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700" required></div>
                        <div><label for="b-padre" class="block text-sm font-medium">Hijo de (Padre)</label><input name="padre" type="text" id="b-padre" class="mt-1 block w-full rounded-md p-2 border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700"></div>
                        <div><label for="b-madre" class="block text-sm font-medium">y de (Madre)</label><input name="madre" type="text" id="b-madre" class="mt-1 block w-full rounded-md p-2 border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700" required></div>
                        <div><label for="b-fecha-bautismo" class="block text-sm font-medium">Fecha del Bautismo</label><input name="fechaBautismo" type="date" id="b-fecha-bautismo" class="mt-1 block w-full rounded-md p-2 border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700" required></div>
                        <div><label for="b-padrino" class="block text-sm font-medium">Padrino</label><input name="padrino" type="text" id="b-padrino" class="mt-1 block w-full rounded-md p-2 border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700" required></div>
                        <div><label for="b-madrina" class="block text-sm font-medium">Madrina</label><input name="madrina" type="text" id="b-madrina" class="mt-1 block w-full rounded-md p-2 border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700" required></div>
                        <div class="md:col-span-2"><label for="b-notas" class="block text-sm font-medium">Notas Marginales</label><textarea name="notas" id="b-notas" rows="3" class="mt-1 block w-full rounded-md p-2 border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700"></textarea></div>
                        <div class="md:col-span-2 flex justify-end space-x-4">
                            <button type="submit" data-action="save-certificate" data-type="bautismo" class="bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white font-bold py-2 px-6 rounded-lg flex items-center space-x-2 transition-all duration-300 ease-in-out transform hover:scale-105">
                                <i data-feather="save" class="h-4 w-4"></i>
                                <span>Guardar</span>
                            </button>
                        </div>
                    </form>
                    <div class="mt-8 border-t pt-6">
                        <h3 class="text-xl font-bold mb-4">Registros Guardados</h3>
                        <div id="bautismo-form-records-container" class="space-y-3"></div>
                        <div id="bautismo-form-pagination-container" class="mt-4 flex justify-between items-center"></div>
                    </div>
                </div>
            </div>
        </section>

        <section id="confirmacion-content" data-view="confirmacion-content" class="hidden min-h-screen">
            <div class="container mx-auto px-6 py-12">
                <div class="flex justify-between items-center mb-8">
                    <h2 class="text-3xl font-bold">Gestión de Certificados de Confirmación</h2>
                    <button data-action="show-view" data-view-id="certificate-choice-content" class="bg-gradient-to-r from-gray-500 to-gray-600 hover:from-gray-600 hover:to-gray-700 text-white font-bold py-2 px-4 rounded-lg transition-all duration-300 ease-in-out transform hover:scale-105">Volver a Elegir</button>
                </div>
                <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-8">
                    <form id="confirmation-form" class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
                        <input type="hidden" name="id" id="c-id">
                        <h3 class="col-span-full text-xl font-bold text-gray-900 dark:text-white border-b pb-2">Datos del Certificado</h3>
                        
                        <div class="md:col-span-2"><label for="c-nombre" class="block text-sm font-medium">Certifico que (Nombre completo)</label><input name="nombre" type="text" id="c-nombre" class="mt-1 block w-full rounded-md p-2 border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700" required></div>
                        <div><label for="c-padre" class="block text-sm font-medium">Hijo(a) de</label><input name="padre" type="text" id="c-padre" class="mt-1 block w-full rounded-md p-2 border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700" required></div>
                        <div><label for="c-madre" class="block text-sm font-medium">y de</label><input name="madre" type="text" id="c-madre" class="mt-1 block w-full rounded-md p-2 border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700" required></div>
                        <div><label for="c-padrino" class="block text-sm font-medium">Padrino/Madrina</label><input name="padrino" type="text" id="c-padrino" class="mt-1 block w-full rounded-md p-2 border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700" required></div>
                        <div><label for="c-fecha-confirmacion" class="block text-sm font-medium">Fecha de Confirmación</label><input name="fechaConfirmacion" type="date" id="c-fecha-confirmacion" class="mt-1 block w-full rounded-md p-2 border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700" required></div>
                        <div><label for="c-pagina" class="block text-sm font-medium">Página N°</label><input name="pagina" type="text" id="c-pagina" class="mt-1 block w-full rounded-md p-2 border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700" required></div>
                        <div><label for="c-acta" class="block text-sm font-medium">Acta N°</label><input name="acta" type="text" id="c-acta" class="mt-1 block w-full rounded-md p-2 border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700" required></div>
                        <div>
                            <label for="c-lugar-select" class="block text-sm font-medium">Lugar de expedición</label>
                            <select id="c-lugar-select" class="mt-1 block w-full rounded-md p-2 border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700">
                                <option>Paso de los Libres, Corrientes</option>
                                <option value="otro">Otro...</option>
                            </select>
                            <input type="hidden" name="lugarExpedicion" id="c-lugar-expedicion-hidden" value="Paso de los Libres, Corrientes">
                        </div>
                        <div><label for="c-fecha-expedicion" class="block text-sm font-medium">Fecha de expedición</label><input name="fechaExpedicion" type="date" id="c-fecha-expedicion" class="mt-1 block w-full rounded-md p-2 border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700" required></div>
                        <div class="md:col-span-2"><label for="c-parroco" class="block text-sm font-medium">Párroco/Ministro</label><input name="parroco" type="text" id="c-parroco" class="mt-1 block w-full rounded-md p-2 border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700" required></div>

                        <h3 class="col-span-full text-xl font-bold text-gray-900 dark:text-white border-b pb-2 mt-4">Datos del Bautismo (para notificación)</h3>
                        <div class="md:col-span-2"><label for="c-bautizado-en" class="block text-sm font-medium">Bautizado en la Pquia.</label><input name="bautizadoEn" type="text" id="c-bautizado-en" class="mt-1 block w-full rounded-md p-2 border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700" required></div>
                        <div><label for="c-bautizado-diocesis" class="block text-sm font-medium">Diócesis (Bautismo)</label><input name="bautizadoDiocesis" type="text" id="c-bautizado-diocesis" class="mt-1 block w-full rounded-md p-2 border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700" required></div>
                        <div class="md:col-span-2"></div>
                        <div><label for="c-bautizado-libro" class="block text-sm font-medium">Libro (Bautismo)</label><input name="bautizadoLibro" type="text" id="c-bautizado-libro" class="mt-1 block w-full rounded-md p-2 border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700" required></div>
                        <div><label for="c-bautizado-folio" class="block text-sm font-medium">Folio (Bautismo)</label><input name="bautizadoFolio" type="text" id="c-bautizado-folio" class="mt-1 block w-full rounded-md p-2 border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700" required></div>

                        <div class="md:col-span-2 flex justify-end space-x-4 mt-6">
                            <button type="submit" data-action="save-certificate" data-type="confirmacion" class="bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white font-bold py-2 px-6 rounded-lg flex items-center space-x-2 transition-all duration-300 ease-in-out transform hover:scale-105">
                                <i data-feather="save" class="h-4 w-4"></i>
                                <span>Guardar</span>
                            </button>
                        </div>
                    </form>
                    <div class="mt-8 border-t pt-6">
                        <h3 class="text-xl font-bold mb-4">Registros Guardados</h3>
                        <div id="confirmacion-form-records-container" class="space-y-3"></div>
                        <div id="confirmacion-form-pagination-container" class="mt-4 flex justify-between items-center"></div>
                    </div>
                </div>
            </div>
        </section>
        
        <section id="mass-org-content" data-view="mass-org-content" class="hidden min-h-screen">
            <div class="container mx-auto px-6 py-12">
                <div class="flex justify-between items-center mb-8 no-print">
                    <h2 class="text-3xl font-bold">Organización de Misas y Ministros</h2>
                    <div class="flex items-center space-x-4">
                        <button data-action="download-mass-org-pdf" class="bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white font-bold py-2 px-4 rounded-lg transition-all duration-300 ease-in-out transform hover:scale-105 flex items-center space-x-2">
                            <i data-feather="download" class="h-4 w-4"></i>
                            <span>Descargar PDF</span>
                        </button>
                        <button data-action="show-view" data-view-id="secretaria-dashboard" class="bg-gradient-to-r from-gray-500 to-gray-600 hover:from-gray-600 hover:to-gray-700 text-white font-bold py-2 px-4 rounded-lg transition-all duration-300 ease-in-out transform hover:scale-105">Inicio</button>
                    </div>
                </div>
                <div id="mass-org-print-area" class="space-y-12 bg-white dark:bg-slate-900 p-8 rounded-lg">
                    <div class="text-center mb-8">
                        <h1 class="text-3xl font-bold text-gray-800 dark:text-gray-200">Parroquia San José</h1>
                        <p class="text-lg text-gray-600 dark:text-gray-400">Paso de los Libres, Corrientes</p>
                    </div>

                    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-8">
                        <h3 class="text-2xl font-bold mb-4">Organización para el servicio litúrgico (Ministros)</h3>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                                <thead class="bg-gray-50 dark:bg-gray-700">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Semanas</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Sábado 19:30 H</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Domingo 08:00 H</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Domingo 10:30 H</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Domingo 20:00 H</th>
                                        <th class="px-6 py-3 text-center text-xs font-medium uppercase no-print">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="ministros-table-body" class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                                    </tbody>
                            </table>
                        </div>
                         <div class="mt-4 text-right no-print"><button data-action="add-row" data-table="ministros" class="bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white font-bold py-2 px-4 rounded-lg transition-all duration-300 ease-in-out transform hover:scale-105">Agregar Fila</button></div>
                    </div>

                    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-8">
                        <h3 class="text-2xl font-bold mb-4">Organización de las Misas (Grupos)</h3>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                                <thead class="bg-gray-50 dark:bg-gray-700">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium uppercase">Semanas</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium uppercase">Sábado 19:30 H</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium uppercase">Domingo 08:00 H</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium uppercase">Domingo 10:30 H</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium uppercase">Domingo 19:30 H</th>
                                        <th class="px-6 py-3 text-center text-xs font-medium uppercase no-print">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="grupos-table-body" class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700"></tbody>
                            </table>
                        </div>
                        <div class="mt-4 text-right no-print"><button data-action="add-row" data-table="grupos" class="bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white font-bold py-2 px-4 rounded-lg transition-all duration-300 ease-in-out transform hover:scale-105">Agregar Fila</button></div>
                    </div>

                    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-8">
                        <h3 class="text-2xl font-bold mb-6">Organización de la Adoración</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-x-12 gap-y-8">
                            
                            <div>
                                <h4 class="text-xl font-semibold mb-4">Adoración de los Jueves</h4>
                                <div class="overflow-x-auto">
                                    <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                                        <thead class="bg-gray-50 dark:bg-gray-700">
                                            <tr>
                                                <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Semanas</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Ministro</th>
                                                <th class="px-6 py-3 text-center text-xs font-medium uppercase no-print">Acciones</th>
                                            </tr>
                                        </thead>
                                        <tbody id="adoracion-jueves-table-body" class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                                            </tbody>
                                    </table>
                                </div>
                                <div class="mt-4 text-right no-print"><button data-action="add-row" data-table="adoracionJueves" class="bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white font-bold py-2 px-4 rounded-lg transition-all duration-300 ease-in-out transform hover:scale-105">Agregar Fila</button></div>
                                
                                <div id="adoracion-jueves-horarios" class="mt-4 p-4 bg-gray-50 dark:bg-gray-700 rounded-lg">
                                    <h5 class="font-bold">Horarios de la Adoración (Jueves)</h5>
                                    <p class="mt-2">Exposición: <span contenteditable="true" data-key="juevesExpo" class="editable-field"></span></p>
                                    <p class="mt-1">Reserva: <span contenteditable="true" data-key="juevesReserva" class="editable-field"></span></p>
                                    <div class="text-right mt-2 no-print">
                                        <button data-action="save-horarios" class="bg-blue-500 hover:bg-blue-600 text-white text-xs font-bold py-1 px-3 rounded-md transition-all">Guardar</button>
                                    </div>
                                </div>
                                </div>
                        
                            <div>
                                <h4 class="text-xl font-semibold mb-4">Adoración de Martes a Viernes</h4>
                                <div class="overflow-x-auto">
                                    <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                                        <thead class="bg-gray-50 dark:bg-gray-700">
                                            <tr>
                                                <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Días</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Ministro</th>
                                                <th class="px-6 py-3 text-center text-xs font-medium uppercase no-print">Acciones</th>
                                            </tr>
                                        </thead>
                                        <tbody id="adoracion-semanal-table-body" class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                                            </tbody>
                                    </table>
                                </div>
                                <div class="mt-4 text-right no-print"><button data-action="add-row" data-table="adoracionSemanal" class="bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white font-bold py-2 px-4 rounded-lg transition-all duration-300 ease-in-out transform hover:scale-105">Agregar Fila</button></div>

                                <div id="adoracion-semanal-horarios" class="mt-4 p-4 bg-gray-50 dark:bg-gray-700 rounded-lg">
                                    <h5 class="font-bold">Horarios de la Adoración (Semanal)</h5>
                                    <p class="mt-2">Exposición: <span contenteditable="true" data-key="semanalExpo" class="editable-field"></span></p>
                                    <p class="mt-1">Reserva: <span contenteditable="true" data-key="semanalReserva" class="editable-field"></span></p>
                                    <div class="text-right mt-2 no-print">
                                        <button data-action="save-horarios" class="bg-blue-500 hover:bg-blue-600 text-white text-xs font-bold py-1 px-3 rounded-md transition-all">Guardar</button>
                                    </div>
                                </div>
                                </div>
                        </div>
                    </div>

                </div>
            </div>
        </section>

        <section id="notifications-content" data-view="notifications-content" class="hidden min-h-screen">
           <div class="container mx-auto px-6 py-12">
                <div class="flex justify-between items-center mb-8">
                    <h2 class="text-3xl font-bold">Notificaciones y Recordatorios</h2>
                    <button data-action="show-view" data-view-id="secretaria-dashboard" class="bg-gradient-to-r from-gray-500 to-gray-600 hover:from-gray-600 hover:to-gray-700 text-white font-bold py-2 px-4 rounded-lg transition-all duration-300 ease-in-out transform hover:scale-105">Inicio</button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                    <div class="md:col-span-1">
                        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-8">
                            <h3 class="text-xl font-bold mb-4">Nueva Notificación</h3>
                            <form id="notification-form" class="space-y-4">
                                <textarea id="notification-text" rows="4" class="w-full rounded-md p-2 border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700" placeholder="Escribe tu recordatorio aquí..." required></textarea>
                                <div>
                                    <label for="notification-priority" class="block text-sm font-medium">Prioridad</label>
                                    <select id="notification-priority" class="mt-1 block w-full rounded-md p-2 border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700">
                                        <option value="normal">Normal</option>
                                        <option value="importante">Importante</option>
                                        <option value="urgente">Urgente</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="notification-due-date" class="block text-sm font-medium">Fecha de Vencimiento</label>
                                    <input type="date" id="notification-due-date" class="mt-1 block w-full rounded-md p-2 border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700">
                                </div>
                                <button type="submit" class="mt-4 w-full bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white font-bold py-2 px-4 rounded-lg transition-all duration-300 ease-in-out transform hover:scale-105">Agregar</button>
                            </form>
                        </div>
                    </div>
                    <div class="md:col-span-2">
                        <div id="notifications-list" class="space-y-4"></div>
                    </div>
                </div>
           </div>
        </section>
    </main>

    <div id="edit-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center p-4 no-print z-50">
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-8 w-full max-w-lg">
            <h3 id="edit-modal-title" class="text-2xl font-bold mb-6">Modificar Fila</h3>
            <form id="edit-form">
                <input type="hidden" id="edit-id">
                <input type="hidden" id="edit-table">
                <div class="space-y-4">
                    <div><label for="edit-semana" class="block text-sm font-medium">Semanas</label><input type="text" id="edit-semana" class="mt-1 block w-full rounded-md p-2 border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700"></div>
                    <div><label for="edit-sabado" class="block text-sm font-medium">Sábado 19:30 H</label><input type="text" id="edit-sabado" class="mt-1 block w-full rounded-md p-2 border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700"></div>
                    <div><label for="edit-dom08" class="block text-sm font-medium">Domingo 08:00 H</label><input type="text" id="edit-dom08" class="mt-1 block w-full rounded-md p-2 border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700"></div>
                    <div><label for="edit-dom10" class="block text-sm font-medium">Domingo 10:30 H</label><input type="text" id="edit-dom10" class="mt-1 block w-full rounded-md p-2 border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700"></div>
                    <div><label for="edit-dom20" class="block text-sm font-medium">Domingo 19:30 H / 20:00 H</label><input type="text" id="edit-dom20" class="mt-1 block w-full rounded-md p-2 border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700"></div>
                </div>
                <div class="mt-8 flex justify-end space-x-4">
                    <button type="button" data-action="close-edit-modal" class="bg-gradient-to-r from-gray-500 to-gray-600 hover:from-gray-600 hover:to-gray-700 text-white font-bold py-2 px-4 rounded-lg transition-all duration-300 ease-in-out transform hover:scale-105">Cancelar</button>
                    <button type="submit" class="bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white font-bold py-2 px-4 rounded-lg transition-all duration-300 ease-in-out transform hover:scale-105">Guardar Cambios</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="edit-adoracion-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center p-4 no-print z-50">
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-8 w-full max-w-md">
            <h3 id="edit-adoracion-modal-title" class="text-2xl font-bold mb-6">Modificar Fila de Adoración</h3>
            <form id="edit-adoracion-form">
                <input type="hidden" id="edit-adoracion-id">
                <input type="hidden" id="edit-adoracion-table">
                <div class="space-y-4">
                    <div>
                        <label id="edit-adoracion-label1" for="edit-adoracion-col1" class="block text-sm font-medium">Semanas/Día</label>
                        <input type="text" id="edit-adoracion-col1" class="mt-1 block w-full rounded-md p-2 border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700">
                    </div>
                     <div>
                        <label for="edit-adoracion-col2" class="block text-sm font-medium">Ministro</label>
                        <input type="text" id="edit-adoracion-col2" class="mt-1 block w-full rounded-md p-2 border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700">
                    </div>
                </div>
                <div class="mt-8 flex justify-end space-x-4">
                    <button type="button" data-action="close-edit-adoracion-modal" class="bg-gradient-to-r from-gray-500 to-gray-600 hover:from-gray-600 hover:to-gray-700 text-white font-bold py-2 px-4 rounded-lg">Cancelar</button>
                    <button type="submit" class="bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white font-bold py-2 px-4 rounded-lg">Guardar Cambios</button>
                </div>
            </form>
        </div>
    </div>


    <div id="custom-location-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center p-4 no-print z-50">
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-8 w-full max-w-md">
            <h3 class="text-2xl font-bold mb-6">Ingresar Lugar de Expedición</h3>
            <form id="custom-location-form">
                <div class="space-y-4">
                    <div>
                        <label for="custom-location-input" class="block text-sm font-medium">Lugar</label>
                        <input type="text" id="custom-location-input" class="mt-1 block w-full rounded-md p-2 border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700" required>
                    </div>
                </div>
                <div class="mt-8 flex justify-end space-x-4">
                    <button type="button" data-action="close-custom-location-modal" class="bg-gradient-to-r from-gray-500 to-gray-600 hover:from-gray-600 hover:to-gray-700 text-white font-bold py-2 px-4 rounded-lg transition-all duration-300 ease-in-out transform hover:scale-105">Volver</button>
                    <button type="submit" class="bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white font-bold py-2 px-4 rounded-lg transition-all duration-300 ease-in-out transform hover:scale-105">Confirmar</button>
                </div>
            </form>
        </div>
    </div>

    <div id="delete-confirm-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center p-4 no-print z-50">
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-8 w-full max-w-md">
            <h3 class="text-xl font-bold mb-4">Confirmar Eliminación</h3>
            <p>¿Estás seguro de que deseas eliminar este registro? Esta acción no se puede deshacer.</p>
            <div class="mt-8 flex justify-end space-x-4">
                <button type="button" data-action="cancel-delete" class="bg-gradient-to-r from-gray-500 to-gray-600 hover:from-gray-600 hover:to-gray-700 text-white font-bold py-2 px-4 rounded-lg transition-all duration-300 ease-in-out transform hover:scale-105">Cancelar</button>
                <button type="button" data-action="confirm-delete" class="bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 text-white font-bold py-2 px-4 rounded-lg transition-all duration-300 ease-in-out transform hover:scale-105">Eliminar</button>
            </div>
        </div>
    </div>

    <div id="loading-spinner" class="hidden fixed inset-0 bg-black bg-opacity-60 flex justify-center items-center z-50">
        <div class="spinner h-16 w-16 border-4 rounded-full"></div>
    </div>

    <div id="toast-container" class="fixed bottom-4 right-4 z-50 space-y-2"></div>

    <div id="print-area" class="print-only hidden"></div>

    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, doc, setDoc, addDoc, deleteDoc, query, getDocs, writeBatch } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyD7Exbyew-eGESZHdfetzkFDt5BJxLgPlE",
            authDomain: "secretariaparroquial-c8c72.firebaseapp.com",
            projectId: "secretariaparroquial-c8c72",
            storageBucket: "secretariaparroquial-c8c72.appspot.com",
            messagingSenderId: "850332198124",
            appId: "1:850332198124:web:7eb4e148087d336dbfb1c9"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- MAIN APP LOGIC ---
        document.addEventListener('DOMContentLoaded', () => {
            
            let recordToDelete = { type: null, id: null };
            let unsubscribeListeners = [];

            const appState = {
                notifications: [],
                ministros: [], 
                grupos: [],
                adoracionJueves: [],
                adoracionSemanal: [],
                horariosAdoracion: {}, // MODIFICACIÓN: Nuevo estado para horarios
                bautismos: [],
                confirmaciones: [],
                bautismosSearchTerm: '',
                bautismosCurrentPage: 1,
                confirmacionesSearchTerm: '',
                confirmacionesCurrentPage: 1,
                recordsPerPage: 5,
            };

            const dom = {
                loginView: document.getElementById('login-view'),
                appContainer: document.getElementById('app-container'),
                loginForm: document.getElementById('login-form'),
                logoutBtn: document.getElementById('logout-btn'),
                togglePasswordBtn: document.getElementById('toggle-password'),
                views: document.querySelectorAll('[data-view]'),
                printArea: document.getElementById('print-area'),
                notificationsList: document.getElementById('notifications-list'),
                notificationForm: document.getElementById('notification-form'),
                ministrosTableBody: document.getElementById('ministros-table-body'),
                gruposTableBody: document.getElementById('grupos-table-body'),
                adoracionJuevesTableBody: document.getElementById('adoracion-jueves-table-body'),
                adoracionSemanalTableBody: document.getElementById('adoracion-semanal-table-body'),
                // MODIFICACIÓN: Nuevos elementos del DOM
                adoracionJuevesHorarios: document.getElementById('adoracion-jueves-horarios'),
                adoracionSemanalHorarios: document.getElementById('adoracion-semanal-horarios'),
                baptismForm: document.getElementById('baptism-form'),
                confirmationForm: document.getElementById('confirmation-form'),
                editModal: document.getElementById('edit-modal'),
                editModalTitle: document.getElementById('edit-modal-title'),
                editForm: document.getElementById('edit-form'),
                editAdoracionModal: document.getElementById('edit-adoracion-modal'),
                editAdoracionForm: document.getElementById('edit-adoracion-form'),
                customLocationModal: document.getElementById('custom-location-modal'),
                customLocationForm: document.getElementById('custom-location-form'),
                lugarSelect: document.getElementById('c-lugar-select'),
                hiddenLugarInput: document.getElementById('c-lugar-expedicion-hidden'),
                bautismoRecordsContainer: document.getElementById('bautismo-records-container'),
                bautismoPaginationContainer: document.getElementById('bautismo-pagination-container'),
                bautismoSearchInput: document.getElementById('bautismo-search'),
                confirmacionRecordsContainer: document.getElementById('confirmacion-records-container'),
                confirmacionPaginationContainer: document.getElementById('confirmacion-pagination-container'),
                confirmacionSearchInput: document.getElementById('confirmacion-search'),
                bautismoFormRecordsContainer: document.getElementById('bautismo-form-records-container'),
                bautismoFormPaginationContainer: document.getElementById('bautismo-form-pagination-container'),
                confirmacionFormRecordsContainer: document.getElementById('confirmacion-form-records-container'),
                confirmacionFormPaginationContainer: document.getElementById('confirmacion-form-pagination-container'),
                deleteConfirmModal: document.getElementById('delete-confirm-modal'),
                notificationBadge: document.getElementById('notification-badge'),
                loadingSpinner: document.getElementById('loading-spinner'),
                toastContainer: document.getElementById('toast-container'),
            };

            const showSpinner = () => dom.loadingSpinner.classList.remove('hidden');
            const hideSpinner = () => dom.loadingSpinner.classList.add('hidden');

            const showToast = (message, type = 'success') => {
                const toast = document.createElement('div');
                const bgColor = type === 'success' ? 'bg-green-500' : 'bg-red-500';
                toast.className = `toast text-white px-6 py-3 rounded-lg shadow-lg ${bgColor}`;
                toast.textContent = message;
                dom.toastContainer.appendChild(toast);
                setTimeout(() => {
                    toast.remove();
                }, 3500);
            };
            
            // MODIFICACIÓN: Nueva función para renderizar horarios editables
            const renderHorariosAdoracion = () => {
                if (!dom.adoracionJuevesHorarios || !dom.adoracionSemanalHorarios) return;
                
                const data = appState.horariosAdoracion;
                
                dom.adoracionJuevesHorarios.querySelector('[data-key="juevesExpo"]').textContent = data.juevesExpo || '18:30';
                dom.adoracionJuevesHorarios.querySelector('[data-key="juevesReserva"]').textContent = data.juevesReserva || '19:15';
                
                dom.adoracionSemanalHorarios.querySelector('[data-key="semanalExpo"]').textContent = data.semanalExpo || '08:00';
                dom.adoracionSemanalHorarios.querySelector('[data-key="semanalReserva"]').textContent = data.semanalReserva || '12:00';
            };

            // MODIFICACIÓN: Nueva función para guardar horarios editables
            const handleSaveHorarios = async () => {
                showSpinner();
                try {
                    const newData = {
                        juevesExpo: dom.adoracionJuevesHorarios.querySelector('[data-key="juevesExpo"]').textContent.trim(),
                        juevesReserva: dom.adoracionJuevesHorarios.querySelector('[data-key="juevesReserva"]').textContent.trim(),
                        semanalExpo: dom.adoracionSemanalHorarios.querySelector('[data-key="semanalExpo"]').textContent.trim(),
                        semanalReserva: dom.adoracionSemanalHorarios.querySelector('[data-key="semanalReserva"]').textContent.trim(),
                    };
                    
                    const horariosDocRef = doc(db, 'parroquia/shared-data/configuracion', 'horariosAdoracion');
                    await setDoc(horariosDocRef, newData);
                    
                    showToast('Horarios actualizados con éxito');
                } catch (error) {
                    console.error("Error saving horarios:", error);
                    showToast('Error al guardar los horarios.', 'error');
                } finally {
                    hideSpinner();
                }
            };

            const updateNotificationBell = () => {
                const alertCount = appState.notifications.filter(n => n.priority === 'importante' || n.priority === 'urgente').length;
                if (alertCount > 0) {
                    dom.notificationBadge.textContent = alertCount;
                    dom.notificationBadge.classList.remove('hidden');
                } else {
                    dom.notificationBadge.classList.add('hidden');
                }
            };

            const renderNotifications = () => {
                const priorityClasses = {
                    normal: 'border-gray-200 dark:border-gray-700',
                    importante: 'border-yellow-500',
                    urgente: 'border-red-500',
                };
                const today = new Date();
                today.setHours(0, 0, 0, 0);

                dom.notificationsList.innerHTML = appState.notifications.map(n => {
                    const isOverdue = n.dueDate && new Date(n.dueDate) < today;
                    const dateColor = isOverdue ? 'text-red-500' : 'text-gray-500 dark:text-gray-400';
                    return `
                    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-6 border-l-4 ${priorityClasses[n.priority]}">
                        <div class="flex justify-between items-start">
                            <p class="text-gray-800 dark:text-gray-200">${n.text}</p>
                            <button data-action="remove-notification" data-id="${n.id}" class="text-red-500 hover:text-red-700 no-print ml-4">
                                <i data-feather="trash-2" class="h-4 w-4"></i>
                            </button>
                        </div>
                        ${n.dueDate ? `<p class="text-sm mt-2 ${dateColor}">Vence: ${formatDate(n.dueDate)}</p>` : ''}
                    </div>
                `}).join('');
                feather.replace();
                updateNotificationBell();
            };

            const renderStandardTable = (tableKey, tbodyElement) => {
                if (!tbodyElement) return;
                tbodyElement.innerHTML = appState[tableKey].map(row => `
                    <tr data-id="${row.id}">
                        <td class="px-6 py-4">${row.semana || ''}</td>
                        <td class="px-6 py-4">${row.sabado || ''}</td>
                        <td class="px-6 py-4">${row.dom08 || ''}</td>
                        <td class="px-6 py-4">${row.dom10 || ''}</td>
                        <td class="px-6 py-4">${row.dom20 || ''}</td>
                        <td class="px-6 py-4 text-center no-print">
                            <div class="flex justify-center items-center space-x-2">
                                <button data-action="show-edit-modal" data-table="${tableKey}" data-id="${row.id}" class="text-blue-500 hover:text-blue-700 p-1" title="Editar">
                                    <i data-feather="edit" class="h-4 w-4"></i>
                                </button>
                                <button data-action="remove-row" data-table="${tableKey}" data-id="${row.id}" class="text-red-500 hover:text-red-700 p-1" title="Eliminar">
                                    <i data-feather="trash-2" class="h-4 w-4"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `).join('');
                feather.replace();
            };

            const renderAdoracionTable = (tableKey, tbodyElement) => {
                if (!tbodyElement) return;
                tbodyElement.innerHTML = appState[tableKey].map(row => `
                       <tr data-id="${row.id}">
                            <td class="px-6 py-4">${row.col1 || ''}</td>
                            <td class="px-6 py-4">${row.col2 || ''}</td>
                            <td class="px-6 py-4 text-center no-print">
                                <div class="flex justify-center items-center space-x-2">
                                    <button data-action="show-edit-adoracion-modal" data-table="${tableKey}" data-id="${row.id}" class="text-blue-500 hover:text-blue-700 p-1" title="Editar">
                                        <i data-feather="edit" class="h-4 w-4"></i>
                                    </button>
                                    <button data-action="remove-row" data-table="${tableKey}" data-id="${row.id}" class="text-red-500 hover:text-red-700 p-1" title="Eliminar">
                                        <i data-feather="trash-2" class="h-4 w-4"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                `).join('');
                feather.replace();
            };


            const renderRecords = (type, container, paginationContainer, searchTerm, currentPageKey) => {
                if (!container || !paginationContainer) return;
                const isBautismo = type === 'bautismo';
                const records = isBautismo ? appState.bautismos : appState.confirmaciones;
                
                const filteredRecords = records.filter(r => {
                    if (!searchTerm) return true;
                    const searchIn = [r.nombre, r.fechaBautismo, r.fechaConfirmacion, r.padre, r.madre, r.padrino, r.madrina].join(' ').toLowerCase();
                    return searchIn.includes(searchTerm.toLowerCase());
                }).sort((a, b) => {
                    const dateA = new Date(isBautismo ? a.fechaBautismo : a.fechaConfirmacion);
                    const dateB = new Date(isBautismo ? b.fechaBautismo : b.fechaConfirmacion);
                    if (isNaN(dateA)) return 1;
                    if (isNaN(dateB)) return -1;
                    return dateB - dateA;
                });

                const totalPages = Math.ceil(filteredRecords.length / appState.recordsPerPage);
                let currentPage = appState[currentPageKey];
                if (currentPage > totalPages) currentPage = totalPages || 1;
                appState[currentPageKey] = currentPage;

                const start = (currentPage - 1) * appState.recordsPerPage;
                const end = start + appState.recordsPerPage;
                const paginatedRecords = filteredRecords.slice(start, end);

                if (paginatedRecords.length === 0) {
                    container.innerHTML = `<p class="text-gray-500 dark:text-gray-400 italic">No hay registros para mostrar.</p>`;
                } else {
                    container.innerHTML = paginatedRecords.map(r => `
                        <div class="bg-white dark:bg-gray-800 rounded-lg p-3 shadow flex justify-between items-center">
                            <div>
                                <p class="font-bold">${r.nombre}</p>
                                <p class="text-sm text-gray-600 dark:text-gray-400">Fecha: ${isBautismo ? formatDate(r.fechaBautismo) : formatDate(r.fechaConfirmacion)}</p>
                            </div>
                            <div class="flex items-center space-x-2">
                                <button data-action="edit-record" data-type="${type}" data-id="${r.id}" class="text-blue-500 hover:text-blue-700 p-1" title="Modificar"><i data-feather="edit" class="h-4 w-4"></i></button>
                                <button data-action="download-record-pdf" data-type="${type}" data-id="${r.id}" class="text-green-500 hover:text-green-700 p-1" title="Descargar PDF"><i data-feather="download" class="h-4 w-4"></i></button>
                                <button data-action="delete-record" data-type="${type}" data-id="${r.id}" class="text-red-500 hover:text-red-700 p-1" title="Eliminar"><i data-feather="trash-2" class="h-4 w-4"></i></button>
                            </div>
                        </div>
                    `).join('');
                }

                paginationContainer.innerHTML = `
                    <button data-action="paginate" data-type="${type}" data-direction="prev" class="px-3 py-1 bg-gray-200 dark:bg-gray-700 rounded ${currentPage === 1 ? 'opacity-50 cursor-not-allowed' : ''}" ${currentPage === 1 ? 'disabled' : ''}>Anterior</button>
                    <span class="text-sm text-gray-600 dark:text-gray-400">Página ${currentPage} de ${totalPages || 1}</span>
                    <button data-action="paginate" data-type="${type}" data-direction="next" class="px-3 py-1 bg-gray-200 dark:bg-gray-700 rounded ${currentPage === totalPages || totalPages === 0 ? 'opacity-50 cursor-not-allowed' : ''}" ${currentPage === totalPages || totalPages === 0 ? 'disabled' : ''}>Siguiente</button>
                `;
                feather.replace();
            };
            
            const showView = (viewId, isEdit = false) => {
                dom.views.forEach(view => {
                    view.classList.toggle('hidden', view.dataset.view !== viewId);
                });
                if (viewId === 'bautismo-content' && !isEdit) dom.baptismForm.reset();
                if (viewId === 'confirmacion-content' && !isEdit) {
                    dom.confirmationForm.reset();
                    const today = new Date().toISOString().split('T')[0];
                    document.getElementById('c-fecha-expedicion').value = today;
                }
                if (viewId === 'mass-org-content') {
                    renderStandardTable('ministros', dom.ministrosTableBody);
                    renderStandardTable('grupos', dom.gruposTableBody);
                    renderAdoracionTable('adoracionJueves', dom.adoracionJuevesTableBody);
                    renderAdoracionTable('adoracionSemanal', dom.adoracionSemanalTableBody);
                    renderHorariosAdoracion(); // Cargar horarios editables
                }
                if (viewId === 'certificate-choice-content' || viewId === 'bautismo-content' || viewId === 'confirmacion-content') {
                    renderRecords('bautismo', dom.bautismoRecordsContainer, dom.bautismoPaginationContainer, appState.bautismosSearchTerm, 'bautismosCurrentPage');
                    renderRecords('confirmacion', dom.confirmacionRecordsContainer, dom.confirmacionPaginationContainer, appState.confirmacionesSearchTerm, 'confirmacionesCurrentPage');
                    renderRecords('bautismo', dom.bautismoFormRecordsContainer, dom.bautismoFormPaginationContainer, '', 'bautismosCurrentPage');
                    renderRecords('confirmacion', dom.confirmacionFormRecordsContainer, dom.confirmacionFormPaginationContainer, '', 'confirmacionesCurrentPage');
                }
                feather.replace();
            };

            const showEditModal = (table, id) => {
                const rowData = appState[table].find(row => row.id === id);
                if (!rowData) return;
                dom.editModalTitle.innerText = `Modificar Fila de ${table === 'ministros' ? 'Ministros' : 'Grupos'}`;
                dom.editForm.querySelector('#edit-id').value = rowData.id;
                dom.editForm.querySelector('#edit-table').value = table;
                dom.editForm.querySelector('#edit-semana').value = rowData.semana || '';
                dom.editForm.querySelector('#edit-sabado').value = rowData.sabado || '';
                dom.editForm.querySelector('#edit-dom08').value = rowData.dom08 || '';
                dom.editForm.querySelector('#edit-dom10').value = rowData.dom10 || '';
                dom.editForm.querySelector('#edit-dom20').value = rowData.dom20 || '';
                dom.editModal.classList.remove('hidden');
            };

            const showEditAdoracionModal = (table, id) => {
                const rowData = appState[table].find(row => row.id === id);
                if (!rowData) return;
                const isJueves = table === 'adoracionJueves';
                dom.editAdoracionModal.querySelector('#edit-adoracion-modal-title').innerText = `Modificar Fila de Adoración`;
                dom.editAdoracionModal.querySelector('#edit-adoracion-id').value = id;
                dom.editAdoracionModal.querySelector('#edit-adoracion-table').value = table;
                dom.editAdoracionModal.querySelector('#edit-adoracion-label1').innerText = isJueves ? 'Semanas' : 'Día';
                dom.editAdoracionModal.querySelector('#edit-adoracion-col1').value = rowData.col1 || '';
                dom.editAdoracionModal.querySelector('#edit-adoracion-col2').value = rowData.col2 || '';
                dom.editAdoracionModal.classList.remove('hidden');
            };

            const closeEditModal = () => dom.editModal.classList.add('hidden');
            const closeEditAdoracionModal = () => dom.editAdoracionModal.classList.add('hidden');
            const closeCustomLocationModal = () => {
                dom.customLocationModal.classList.add('hidden');
                dom.lugarSelect.value = dom.hiddenLugarInput.value;
            };

            const handleCertificateAction = async (type, format, existingData = null) => {
                let formData = existingData;
                if (!formData) {
                    showToast('No hay datos para esta acción.', 'error');
                    return;
                }

                showSpinner();
                const certificateHTML = getCertificateHTML(type, formData);
                if (!certificateHTML) {
                    hideSpinner();
                    showToast('Error al crear el HTML del certificado', 'error');
                    return;
                }

                try {
                    if (format === 'pdf') {
                        const elementToRender = document.createElement('div');
                        elementToRender.innerHTML = certificateHTML;
                        document.body.appendChild(elementToRender);
                        const { jsPDF } = window.jspdf;
                        const canvas = await html2canvas(elementToRender.firstChild, { scale: 3 });
                        const imgData = canvas.toDataURL('image/png');
                        const pdf = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4' });
                        pdf.addImage(imgData, 'PNG', 0, 0, 210, 297);
                        pdf.save(`Certificado_${type}_${formData.nombre.replace(/ /g, '_')}.pdf`);
                        document.body.removeChild(elementToRender);
                        showToast('PDF generado con éxito');
                    }
                } catch (error) {
                    console.error("Error generating document:", error);
                    showToast('Error al generar el documento', 'error');
                } finally {
                    hideSpinner();
                }
            };
            
            const saveCertificate = async (type) => {
                const form = type === 'bautismo' ? dom.baptismForm : dom.confirmationForm;
                if (!form.checkValidity()) {
                    form.reportValidity();
                    return;
                }
                const formData = Object.fromEntries(new FormData(form).entries());
                const recordId = formData.id;
                
                const collectionName = type === 'confirmacion' ? 'confirmaciones' : `${type}s`;
                const collectionPath = `parroquia/shared-data/${collectionName}`;

                try {
                    if (recordId) { // Update
                        await setDoc(doc(db, collectionPath, recordId), formData, { merge: true });
                        showToast('Registro actualizado con éxito');
                    } else { // Create
                        const newRecord = { ...formData, generatedAt: new Date().toISOString() };
                        delete newRecord.id;
                        await addDoc(collection(db, collectionPath), newRecord);
                        showToast('Registro guardado con éxito');
                    }
                    form.reset();
                    if (type === 'confirmacion') {
                        const today = new Date().toISOString().split('T')[0];
                        document.getElementById('c-fecha-expedicion').value = today;
                    }
                } catch (error) {
                    console.error("Firestore error:", error);
                    showToast('Error al guardar: verifique los permisos de la base de datos', 'error');
                }
            };

            const formatDate = (dateString, format = 'short') => {
                if (!dateString) return '';
                const date = new Date(dateString);
                const options = { timeZone: 'UTC' };
                if (format === 'long') {
                    options.day = 'numeric';
                    options.month = 'long';
                    options.year = 'numeric';
                    return date.toLocaleDateString('es-AR', options);
                }
                 if (format === 'long_parts') {
                    const day = date.getUTCDate();
                    const month = date.toLocaleDateString('es-AR', { month: 'long', timeZone: 'UTC' });
                    const year = date.getUTCFullYear();
                    return `a los ${day} días del mes de ${month} de ${year}`;
                }
                return date.toLocaleDateString('es-AR', options);
            };

            const getCertificateHTML = (type, data) => {
                if (type === 'bautismo') {
                    const header = `<div class="certificate-modern-header"><h3>CERTIFICADO DE BAUTISMO</h3><p>Diócesis de Santo Tomé - Paso de los Libres – Corrientes<br>Dirección: Bartolomé Mitre 940<br>WhatsApp (3772) 651931</p></div>`;
                    const body = `<div class="certificate-modern-body"><p>Se certifica que en el libro N° <span class="field">${data.libro || ''}</span>, Folio N° <span class="field">${data.folio || ''}</span>, se encuentra la partida de Bautismo de: <strong>${(data.nombre || '').toUpperCase()}</strong>, nacido/a en <span class="field">${data.lugarNac || ''}</span> el <span class="field">${formatDate(data.fechaNac)}</span>, hijo/a de <span class="field">${data.padre || ''}</span> y de <span class="field">${data.madre || ''}</span>. Fue bautizado/a el día <span class="field">${formatDate(data.fechaBautismo)}</span>, siendo sus padrinos <span class="field">${data.padrino || ''}</span> y <span class="field">${data.madrina || ''}</span>.</p><p><strong>Notas:</strong> ${data.notas || 'Ninguna'}</p></div>`;
                    const footer = `<div class="certificate-modern-footer"><div class="signature-line">Sello Parroquial</div><div class="signature-line">Firma del Párroco</div></div>`;
                    return `<div class="pdf-page-container"><div class="certificate-modern">${header}${body}${footer}</div></div>`;
                }
                
                if (type === 'confirmacion') {
                    const mainCert = `
                        <div class="certificate-modern" style="height: 140mm; display: flex; flex-direction: column;">
                            <div class="certificate-modern-header">
                                <h3>CERTIFICADO DE CONFIRMACIÓN</h3>
                                <p>DIOCESIS DE SANTO TOME CORRIENTES</p>
                                <p><b>Parroquia:</b> San José</p>
                                <p><b>Localidad:</b> Paso de los Libres, Corrientes</p>
                            </div>
                            <div class="certificate-modern-body" style="flex-grow: 1;">
                                <p>Certifico que: <strong>${(data.nombre || '').toUpperCase()}</strong></p>
                                <p>hijo(a) de <span class="field">${data.padre || ''}</span> y de <span class="field">${data.madre || ''}</span>&nbsp;
                                ha recibido solemnemente el Sacramento de la Confirmación en esta parroquia el día ${formatDate(data.fechaConfirmacion, 'long')}.</p>
                                <p>Registrado en el Libro Parroquial de Confirmaciones, página <span class="field">${data.pagina || ''}</span>, acta Nº <span class="field">${data.acta || ''}</span>.</p>
                                <p>En <span class="field">${data.lugarExpedicion || ''}</span>, ${formatDate(data.fechaExpedicion, 'long_parts')}.</p>
                            </div>
                            <div class="certificate-modern-footer">
                                <div class="signature-line">Sello parroquial</div>
                                <div class="signature-line">Pbro. ${data.parroco || ''} <br> Párroco</div>
                            </div>
                        </div>`;
                    
                    const notificationBox = `
                        <div class="notification-box">
                            <h4>DIOCESIS DE SANTO TOME-CORRIENTES</h4>
                            <p>Parroquia:<span class="field-line">San José</span></p>
                            <p>Localidad:<span class="field-line">Paso de los Libres, Corrientes</span></p>
                            <h4 style="margin-top: 5mm;">NOTIFICACION DE CONFIRMACION</h4>
                            <p>Nombre y Apellido:<span class="field-line">${data.nombre || ''}</span></p>
                            <p>Bautizado en la Pquia.:<span class="field-line">${data.bautizadoEn || ''}</span></p>
                            <div style="display: flex; gap: 10px;">
                                <p>L.<span class="field-line">${data.bautizadoLibro || ''}</span></p>
                                <p>F.<span class="field-line">${data.bautizadoFolio || ''}</span></p>
                            </div>
                            <p>Diócesis:<span class="field-line">${data.bautizadoDiocesis || ''}</span></p>
                            <p>Fue Confirmado el:<span class="field-line">${formatDate(data.fechaConfirmacion)}</span></p>
                            <p>Registrado en L.<span class="field-line">${data.pagina || ''}</span> F.<span class="field-line">${data.acta || ''}</span></p>
                            <div style="display: flex; justify-content: space-between; margin-top: 10mm;">
                                <span>Sello</span>
                                <span>Párroco</span>
                            </div>
                            <p class="footer-note">PARA ENVIAR A LA PARROQUIA DONDE SE CONFIRIO EL BAUTISMO</p>
                        </div>`;

                    const fichaBox = `
                        <div class="notification-box">
                            <h4>DIOCESIS DE SANTO TOME-CORRIENTES</h4>
                            <p>Parroquia:<span class="field-line">San José</span></p>
                            <p>Localidad:<span class="field-line">Paso de los Libres, Corrientes</span></p>
                            <h4 style="margin-top: 5mm;">FICHA DE CONFIRMACION</h4>
                            <p>Nombre y Apellido:<span class="field-line">${data.nombre || ''}</span></p>
                            <p>Bautizado en la Pquia.:<span class="field-line">${data.bautizadoEn || ''}</span></p>
                            <div style="display: flex; gap: 10px;">
                                <p>L.<span class="field-line">${data.bautizadoLibro || ''}</span></p>
                                <p>F.<span class="field-line">${data.bautizadoFolio || ''}</span></p>
                            </div>
                            <p>Padre:<span class="field-line">${data.padre || ''}</span></p>
                            <p>Madre:<span class="field-line">${data.madre || ''}</span></p>
                            <p>Padrino/Madrina:<span class="field-line">${data.padrino || ''}</span></p>
                            <p>Fecha:<span class="field-line">${formatDate(data.fechaConfirmacion)}</span></p>
                            <p>Ministro:<span class="field-line">${data.parroco || ''}</span></p>
                            <p class="footer-note">PARA INSCRIBIR EN EL LIBRO PARROQUIAL DE CONFIRMACIONES</p>
                        </div>`;

                    return `<div class="pdf-page-container" style="display: block;">${mainCert}<div class="notification-container" style="flex-grow: 0;">${notificationBox}${fichaBox}</div></div>`;
                }
                return '';
            };

            const populateFormWithRecord = (type, id) => {
                const isBautismo = type === 'bautismo';
                const record = isBautismo ? appState.bautismos.find(r => r.id === id) : appState.confirmaciones.find(r => r.id === id);
                if (!record) return;

                const form = isBautismo ? dom.baptismForm : dom.confirmationForm;
                form.reset();
                Object.keys(record).forEach(key => {
                    const input = form.querySelector(`[name="${key}"]`);
                    if (input) {
                        input.value = record[key];
                    }
                });
                showView(isBautismo ? 'bautismo-content' : 'confirmacion-content', true);
            };

            const initialData = {
                ministros: [
                    { semana: 'Primero', sabado: 'Laura Alvez', dom08: 'Raúl Segovia', dom10: '', dom20: 'Jorge Giménez' },
                    { semana: 'Segundo', sabado: 'Estela Santia', dom08: '', dom10: 'Jorge Gimenez', dom20: 'Maritel Reyero' },
                    { semana: 'Tercero', sabado: 'Raul Segovia', dom08: '', dom10: '', dom20: 'Raul Segovia' },
                    { semana: 'Cuarto', sabado: 'Maritel Reyero', dom08: '', dom10: 'Raul Segovia', dom20: 'Estela Santia' },
                    { semana: 'Quinto', sabado: 'Jorge Giménez', dom08: '', dom10: '', dom20: 'Laura Alvez' }
                ],
                grupos: [
                    { semana: 'Primero', sabado: 'Legión de María', dom08: 'Nora y Silvana', dom10: 'Jardín Semillitas', dom20: 'Taller de oracion y vida' },
                    { semana: 'Segundo', sabado: 'Colegio San José ( Secundario)', dom08: 'Polaqui y Rita', dom10: 'Instituto Niño Jesús', dom20: 'CAE' },
                    { semana: 'Tercero', sabado: 'Renovación Carismática', dom08: 'Estela Y Mónica', dom10: 'Catequesis', dom20: 'Hogares Nuevos' },
                    { semana: 'Cuarto', sabado: 'Cáritas', dom08: 'Liliana', dom10: 'Colegio San José (Primario)', dom20: 'Jesús Misericordioso' },
                    { semana: 'Quinto', sabado: 'Estela Santia', dom08: 'Paula', dom10: 'Catequesis', dom20: 'Apostolado de la Oración' }
                ],
                adoracionJueves: [
                    { col1: 'Primera', col2: 'Laura Alvez' },
                    { col1: 'Segunda', col2: 'Catalina Gonzales' },
                    { col1: 'Tercera', col2: 'Raul Segovia' },
                    { col1: 'Cuarta', col2: 'Maritel Reyero' },
                    { col1: 'Quinta', col2: 'Estela Santia' }
                ],
                adoracionSemanal: [
                    { col1: 'Martes', col2: 'Jorge Giménez' },
                    { col1: 'Miércoles', col2: 'Raul Segovia' },
                    { col1: 'Jueves', col2: 'Maritel Reyero' },
                    { col1: 'Viernes', col2: 'Estela Santia' }
                ]
            };


            const setupInitialData = async () => {
                for (const collectionName in initialData) {
                    const collectionRef = collection(db, `parroquia/shared-data/${collectionName}`);
                    const snapshot = await getDocs(collectionRef);
                    if (snapshot.empty) {
                        console.log(`Populating initial data for ${collectionName}...`);
                        const batch = writeBatch(db);
                        initialData[collectionName].forEach(item => {
                            const docRef = doc(collectionRef);
                            batch.set(docRef, item);
                        });
                        await batch.commit();
                        console.log(`Initial data for ${collectionName} populated.`);
                    }
                }
            };
            
            // MODIFICACIÓN: Nueva función para crear horarios si no existen
            const setupInitialHorarios = async () => {
                const horariosDocRef = doc(db, 'parroquia/shared-data/configuracion', 'horariosAdoracion');
                const initialHorarios = {
                    juevesExpo: '18:30',
                    juevesReserva: '19:15',
                    semanalExpo: '08:00',
                    semanalReserva: '12:00'
                };
                await setDoc(horariosDocRef, initialHorarios);
                appState.horariosAdoracion = initialHorarios;
                renderHorariosAdoracion();
            };

            const downloadMassOrgPdf = async () => {
                showSpinner();
                const { jsPDF } = window.jspdf;
                const printArea = document.getElementById('mass-org-print-area');
                
                const originalPrintAreaClass = printArea.className;
                const cardElements = printArea.querySelectorAll('.bg-white.dark\\:bg-gray-800');
                const originalCardClasses = Array.from(cardElements).map(el => el.className);
                const textElements = printArea.querySelectorAll('.dark\\:text-gray-200, .dark\\:text-gray-400');
                const originalTextClasses = Array.from(textElements).map(el => el.className);

                try {
                    printArea.className = 'p-8 bg-white';
                    cardElements.forEach(el => {
                        el.className = 'bg-white p-8';
                    });
                    textElements.forEach(el => {
                        el.classList.remove('dark:text-gray-200', 'dark:text-gray-400');
                        el.classList.add('text-gray-800');
                    });
                    
                    feather.replace();
                    await new Promise(resolve => setTimeout(resolve, 50));
                    
                    const canvas = await html2canvas(printArea, {
                        scale: 2,
                        useCORS: true,
                        backgroundColor: '#ffffff',
                    });
                    
                    const imgData = canvas.toDataURL('image/png');
                    const pdf = new jsPDF({
                        orientation: 'p',
                        unit: 'mm',
                        format: 'a4'
                    });

                    const imgProps = pdf.getImageProperties(imgData);
                    const pdfWidth = pdf.internal.pageSize.getWidth();
                    const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
                    let heightLeft = pdfHeight;
                    let position = 0;
                    
                    pdf.addImage(imgData, 'PNG', 0, position, pdfWidth, pdfHeight);
                    heightLeft -= pdf.internal.pageSize.getHeight();

                    while (heightLeft > 0) {
                        position = heightLeft - pdfHeight;
                        pdf.addPage();
                        pdf.addImage(imgData, 'PNG', 0, position, pdfWidth, pdfHeight);
                        heightLeft -= pdf.internal.pageSize.getHeight();
                    }

                    pdf.save('Organizacion_Misas_y_Ministros.pdf');
                    showToast('PDF descargado con éxito.');

                } catch (error) {
                    console.error('Error al generar el PDF:', error);
                    showToast('Hubo un error al generar el PDF.', 'error');
                } finally {
                    printArea.className = originalPrintAreaClass;
                    cardElements.forEach((el, index) => {
                        el.className = originalCardClasses[index];
                    });
                     textElements.forEach((el, index) => {
                        el.className = originalTextClasses[index];
                    });
                    feather.replace();
                    hideSpinner();
                }
            };

            const setupDataListeners = () => {
                const collections = ['bautismos', 'confirmaciones', 'notifications', 'ministros', 'grupos', 'adoracionJueves', 'adoracionSemanal'];
                unsubscribeListeners.forEach(unsub => unsub());
                unsubscribeListeners = [];

                collections.forEach(coll => {
                    const q = query(collection(db, `parroquia/shared-data/${coll}`));
                    const unsub = onSnapshot(q, (querySnapshot) => {
                        appState[coll] = [];
                        querySnapshot.forEach((doc) => {
                            appState[coll].push({ ...doc.data(), id: doc.id });
                        });

                        switch (coll) {
                            case 'bautismos':
                                renderRecords('bautismo', dom.bautismoRecordsContainer, dom.bautismoPaginationContainer, appState.bautismosSearchTerm, 'bautismosCurrentPage');
                                renderRecords('bautismo', dom.bautismoFormRecordsContainer, dom.bautismoFormPaginationContainer, '', 'bautismosCurrentPage');
                                break;
                            case 'confirmaciones':
                                renderRecords('confirmacion', dom.confirmacionRecordsContainer, dom.confirmacionPaginationContainer, appState.confirmacionesSearchTerm, 'confirmacionesCurrentPage');
                                renderRecords('confirmacion', dom.confirmacionFormRecordsContainer, dom.confirmacionFormPaginationContainer, '', 'confirmacionesCurrentPage');
                                break;
                            case 'notifications':
                                renderNotifications();
                                break;
                            case 'ministros':
                                renderStandardTable('ministros', dom.ministrosTableBody);
                                break;
                            case 'grupos':
                                renderStandardTable('grupos', dom.gruposTableBody);
                                break;
                            case 'adoracionJueves':
                                renderAdoracionTable('adoracionJueves', dom.adoracionJuevesTableBody);
                                break;
                            case 'adoracionSemanal':
                                renderAdoracionTable('adoracionSemanal', dom.adoracionSemanalTableBody);
                                break;
                        }

                    }, (error) => {
                        console.error(`Error listening to ${coll}:`, error);
                        showToast(`Error al cargar ${coll}. Verifique los permisos.`, 'error');
                    });
                    unsubscribeListeners.push(unsub);
                });
                
                // MODIFICACIÓN: Listener para el documento de configuración de horarios
                const horariosDocRef = doc(db, 'parroquia/shared-data/configuracion', 'horariosAdoracion');
                const unsubHorarios = onSnapshot(horariosDocRef, (docSnap) => {
                    if (docSnap.exists()) {
                        appState.horariosAdoracion = docSnap.data();
                    } else {
                        console.log("Horarios config not found. Creating default...");
                        setupInitialHorarios();
                    }
                    renderHorariosAdoracion();
                }, (error) => {
                    console.error("Error listening to horarios config:", error);
                    showToast('Error al cargar la configuración de horarios.', 'error');
                });
                unsubscribeListeners.push(unsubHorarios);
            };

            document.body.addEventListener('click', (e) => {
                const target = e.target.closest('[data-action]');
                if (!target) return;
                const { action, viewId, table, id, type, format, direction } = target.dataset;
                switch (action) {
                    case 'show-view': showView(viewId); break;
                    case 'download-mass-org-pdf': downloadMassOrgPdf(); break;
                    case 'show-edit-modal': showEditModal(table, id); break;
                    case 'close-edit-modal': closeEditModal(); break;
                    case 'show-edit-adoracion-modal': showEditAdoracionModal(table, id); break;
                    case 'close-edit-adoracion-modal': closeEditAdoracionModal(); break;
                    case 'close-custom-location-modal': closeCustomLocationModal(); break;
                    case 'save-horarios': handleSaveHorarios(); break; // MODIFICACIÓN: Nueva acción
                    case 'add-row':
                        const newId = Date.now().toString();
                        let newRowData;
                        if (table === 'adoracionJueves' || table === 'adoracionSemanal') {
                           newRowData = { id: newId, col1: 'Nuevo', col2: '' };
                        } else {
                           newRowData = { id: newId, semana: 'Nueva', sabado: '', dom08: '', dom10: '', dom20: '' };
                        }
                        setDoc(doc(db, `parroquia/shared-data/${table}`, newId), newRowData);
                        break;
                    case 'remove-row':
                        deleteDoc(doc(db, `parroquia/shared-data/${table}`, id));
                        break;
                    case 'remove-notification':
                        deleteDoc(doc(db, `parroquia/shared-data/notifications`, id));
                        showToast('Notificación eliminada');
                        break;
                    case 'paginate':
                        if (type === 'bautismo') {
                            appState.bautismosCurrentPage += direction === 'next' ? 1 : -1;
                        } else {
                            appState.confirmacionesCurrentPage += direction === 'next' ? 1 : -1;
                        }
                        renderRecords(type, type === 'bautismo' ? dom.bautismoRecordsContainer : dom.confirmacionRecordsContainer, type === 'bautismo' ? dom.bautismoPaginationContainer : dom.confirmacionPaginationContainer, appState[`${type}sSearchTerm`], `${type}sCurrentPage`);
                        break;
                    case 'edit-record':
                        populateFormWithRecord(type, id);
                        break;
                    case 'download-record-pdf':
                        const record = type === 'bautismo' ? appState.bautismos.find(r => r.id === id) : appState.confirmaciones.find(r => r.id === id);
                        if(record) handleCertificateAction(type, 'pdf', record);
                        break;
                    case 'delete-record':
                        recordToDelete = { type, id };
                        dom.deleteConfirmModal.classList.remove('hidden');
                        break;
                    case 'cancel-delete':
                        dom.deleteConfirmModal.classList.add('hidden');
                        recordToDelete = { type: null, id: null };
                        break;
                    case 'confirm-delete':
                        if (recordToDelete.type && recordToDelete.id) {
                            const collectionName = recordToDelete.type === 'confirmacion' ? 'confirmaciones' : `${recordToDelete.type}s`;
                            deleteDoc(doc(db, `parroquia/shared-data/${collectionName}`, recordToDelete.id));
                            showToast('Registro eliminado con éxito');
                        }
                        dom.deleteConfirmModal.classList.add('hidden');
                        recordToDelete = { type: null, id: null };
                        break;
                }
            });

            dom.baptismForm.addEventListener('submit', (e) => {
                e.preventDefault();
                saveCertificate('bautismo');
            });

            dom.confirmationForm.addEventListener('submit', (e) => {
                e.preventDefault();
                saveCertificate('confirmacion');
            });

            dom.bautismoSearchInput.addEventListener('input', (e) => {
                appState.bautismosSearchTerm = e.target.value;
                appState.bautismosCurrentPage = 1;
                renderRecords('bautismo', dom.bautismoRecordsContainer, dom.bautismoPaginationContainer, appState.bautismosSearchTerm, 'bautismosCurrentPage');
            });

            dom.confirmacionSearchInput.addEventListener('input', (e) => {
                appState.confirmacionesSearchTerm = e.target.value;
                appState.confirmacionesCurrentPage = 1;
                renderRecords('confirmacion', dom.confirmacionRecordsContainer, dom.confirmacionPaginationContainer, appState.confirmacionesSearchTerm, 'confirmacionesCurrentPage');
            });

            dom.notificationForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const text = dom.notificationForm.querySelector('#notification-text').value.trim();
                const priority = dom.notificationForm.querySelector('#notification-priority').value;
                const dueDate = dom.notificationForm.querySelector('#notification-due-date').value;
                if (text) {
                    await addDoc(collection(db, `parroquia/shared-data/notifications`), { text, priority, dueDate });
                    dom.notificationForm.reset();
                    showToast('Notificación agregada');
                }
            });

            dom.editForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const id = dom.editForm.querySelector('#edit-id').value;
                const table = dom.editForm.querySelector('#edit-table').value;
                const updatedData = {
                    semana: dom.editForm.querySelector('#edit-semana').value,
                    sabado: dom.editForm.querySelector('#edit-sabado').value,
                    dom08: dom.editForm.querySelector('#edit-dom08').value,
                    dom10: dom.editForm.querySelector('#edit-dom10').value,
                    dom20: dom.editForm.querySelector('#edit-dom20').value,
                };
                await setDoc(doc(db, `parroquia/shared-data/${table}`, id), updatedData, { merge: true });
                closeEditModal();
            });

            dom.editAdoracionForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const id = dom.editAdoracionForm.querySelector('#edit-adoracion-id').value;
                const table = dom.editAdoracionForm.querySelector('#edit-adoracion-table').value;
                const updatedData = {
                    col1: dom.editAdoracionForm.querySelector('#edit-adoracion-col1').value,
                    col2: dom.editAdoracionForm.querySelector('#edit-adoracion-col2').value,
                };
                await setDoc(doc(db, `parroquia/shared-data/${table}`, id), updatedData, { merge: true });
                closeEditAdoracionModal();
            });

            dom.lugarSelect.addEventListener('change', () => {
                if (dom.lugarSelect.value === 'otro') {
                    dom.customLocationModal.classList.remove('hidden');
                    dom.customLocationModal.querySelector('#custom-location-input').focus();
                } else {
                    dom.hiddenLugarInput.value = dom.lugarSelect.value;
                }
            });

            dom.customLocationForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const input = dom.customLocationForm.querySelector('#custom-location-input');
                const customLocation = input.value.trim();
                if (customLocation) {
                    let existingOption = dom.lugarSelect.querySelector(`option[value="${customLocation}"]`);
                    if (!existingOption) {
                        const newOption = document.createElement('option');
                        newOption.value = customLocation;
                        newOption.textContent = customLocation;
                        dom.lugarSelect.insertBefore(newOption, dom.lugarSelect.querySelector('option[value="otro"]'));
                    }
                    dom.lugarSelect.value = customLocation;
                    dom.hiddenLugarInput.value = customLocation;
                    input.value = '';
                    closeCustomLocationModal();
                }
            });

            // --- AUTHENTICATION LOGIC ---
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    dom.loginView.classList.add('hidden');
                    dom.appContainer.classList.remove('hidden');
                    setupInitialData(); // Populate data if needed
                    setupDataListeners();
                    showView('secretaria-dashboard');
                } else {
                    dom.loginView.classList.remove('hidden');
                    dom.appContainer.classList.add('hidden');
                    unsubscribeListeners.forEach(unsub => unsub());
                }
            });

            dom.loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = dom.loginForm.querySelector('#email').value;
                const password = dom.loginForm.querySelector('#password').value;
                showSpinner();
                try {
                    await signInWithEmailAndPassword(auth, email, password);
                    showToast('Inicio de sesión exitoso');
                } catch (error) {
                    console.error("Login error:", error.code);
                    showToast('Correo o contraseña incorrectos', 'error');
                } finally {
                    hideSpinner();
                }
            });

            dom.logoutBtn.addEventListener('click', async () => {
                await signOut(auth);
                showToast('Sesión cerrada');
            });

            dom.togglePasswordBtn.addEventListener('click', () => {
                const passwordInput = document.getElementById('password');
                const iconEye = dom.togglePasswordBtn.querySelector('.icon-eye');
                const iconEyeOff = dom.togglePasswordBtn.querySelector('.icon-eye-off');
                if (passwordInput.type === 'password') {
                    passwordInput.type = 'text';
                    iconEye.classList.add('hidden');
                    iconEyeOff.classList.remove('hidden');
                } else {
                    passwordInput.type = 'password';
                    iconEye.classList.remove('hidden');
                    iconEyeOff.classList.add('hidden');
                }
            });
        });
    </script>
</body>
</html>
